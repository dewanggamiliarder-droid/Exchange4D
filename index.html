<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DEWA4EXCHANGE ‚Äî Rill Market (EDUKASI)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Orbitron:wght@500;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#071018; --card:#0b151b; --muted:#9fb0b8; --accent:#00d084; --accent-2:#00eaff; --danger:#ff4666;
    /* Neon Colors */
    --neon-main: #00eaff;
    --neon-glow: rgba(0, 234, 255, 0.7);
    --neon-shadow: 0 0 5px var(--neon-glow), 0 0 10px var(--neon-glow), 0 0 20px var(--neon-glow);
    /* New Stock Colors */
    --stock-buy: #00ff99; /* Bright green for Buy/Gain */
    --stock-sell: #ff4747; /* Bright red for Sell/Loss */
    --idx-bg: #1a0a28; /* Purple-ish background for IDX */
    --us-bg: #0a1c28; /* Blue-ish background for US */
    --buy-bg-light: rgba(0, 255, 153, 0.08); /* Lighter green for orderbook */
    --sell-bg-light: rgba(255, 71, 71, 0.08); /* Lighter red for orderbook */
    --buy-line: rgba(0, 255, 153, 0.3);
    --sell-line: rgba(255, 71, 71, 0.3);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:'Inter', system-ui, Arial;background:linear-gradient(180deg,var(--bg),#02060a);color:#e6eef2;-webkit-font-smoothing:antialiased}
  a{color:inherit}

  /* Keyframes untuk Animasi */
  @keyframes neon-pulse {
      0%, 100% { text-shadow: var(--neon-shadow); transform: scale(1.0) translateY(0); }
      50% { text-shadow: 0 0 8px var(--neon-glow), 0 0 15px var(--neon-glow), 0 0 25px rgba(0, 234, 255, 0.5); transform: scale(1.02) translateY(-2px); }
  }
  @keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
  }
  
  /* SPLASH SCREEN */
  @keyframes logo-spin {
      0% { transform: rotateY(0deg); opacity: 0; }
      50% { opacity: 1; }
      100% { transform: rotateY(360deg); opacity: 1; }
  }
  @keyframes loading-fade {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
  }
  .intro{
    position:fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    background: linear-gradient(180deg, #02060a 0%, #071018 50%, #02060a 100%);
    z-index:9999;
    transition: opacity 0.7s ease-out;
  }
  .splash-text-wrap {
      text-align: center;
      line-height: 0.9;
      color: var(--neon-main);
      font-family: 'Orbitron', sans-serif;
      animation: float 4s ease-in-out infinite;
      margin-top: 15px;
  }
  .splash-main-text {
      font-weight: 800;
      font-size: 40px;
      animation: neon-pulse 1.8s ease-in-out infinite alternate;
  }
  .splash-sub-text {
      font-weight: 500;
      font-size: 18px;
      letter-spacing: 6px;
      margin-top: 8px;
  }
  .splash-logo-placeholder {
      width: 120px;
      height: 120px;
      border-radius: 20px;
      background: linear-gradient(135deg, var(--accent-2), var(--accent));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 32px;
      color: #021;
      box-shadow: 0 0 10px var(--neon-glow), 0 0 25px var(--neon-glow);
      animation: logo-spin 2s ease-out forwards;
  }
  .loading-msg {
      margin-top: 25px;
      color: var(--muted);
      font-size: 14px;
      animation: loading-fade 1.5s ease-in-out infinite;
  }
  /* END UPDATED SPLASH */


  /* layout */
  .app{max-width:980px;margin:0 auto;padding-bottom:88px}
  header.main{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:transparent;position:sticky;top:0;z-index:50}
  .brand{font-weight:800;letter-spacing:1px;color:var(--accent-2)}
  .search{flex:1;margin:0 12px}
  .btn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:10px;color:var(--muted);cursor:pointer;transition: all 0.3s ease;}
  .btn-primary{background:var(--accent);color:#021;border:none}
  .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:12px;border-radius:10px;margin:12px;border:1px solid rgba(255,255,255,0.03)}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  .market-top{height:320px;background:#07121a;border-radius:10px;overflow:hidden}
  .chart-wrap{width:100%;height:100%}
  .small{font-size:13px;color:var(--muted)}
  .pill{background:rgba(255,255,255,0.02);padding:6px 10px;border-radius:8px;color:var(--muted);font-size:13px}
  /* bottom nav */
  .bottom-nav{position:fixed;right:0;left:0;bottom:0;height:64px;background:linear-gradient(180deg,#07121a,#041018);display:flex;align-items:center;justify-content:space-around;border-top:1px solid rgba(255,255,255,0.03);z-index:60}
  .nav-item{display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--muted);font-size:12px; transition: color 0.3s ease;}
  .nav-item.active{color:var(--accent-2); text-shadow: 0 0 5px rgba(0, 234, 255, 0.5);}
  /* responsive */
  @media(min-width:900px){
    .app{padding:18px}
    .grid{grid-template-columns: 1fr 420px}
    .market-top{height:420px}
  }
  /* forms */
  input,select,textarea{background:transparent;border:1px solid rgba(255,255,255,0.03);padding:10px;border-radius:8px;color:#e6eef2;width:100%;outline:none}
  .mutasi{max-height:220px;overflow:auto;padding:6px}
  .positions{max-height:220px;overflow:auto;padding:6px}
  
  /* LOGIN MODAL BARU */
  #loginModal{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.85);
    align-items:center;
    justify-content:center;
    z-index:999;
    transition: opacity 0.4s ease-in;
  }
  .login-card{
    background: linear-gradient(145deg, #051a1a, #010808);
    padding: 24px;
    border-radius: 16px;
    width: 90%;
    max-width: 380px;
    border: 1px solid rgba(0, 234, 255, 0.2);
    box-shadow: 0 4px 30px rgba(0, 234, 255, 0.2);
  }
  .login-logo-sm {
      width: 40px;
      height: 40px;
      margin: 0 auto 10px;
      border-radius: 8px;
      background: linear-gradient(135deg, var(--accent-2), var(--accent));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 18px;
      color: #021;
      box-shadow: 0 0 10px rgba(0, 234, 255, 0.6);
  }
  .login-title{
      text-align: center;
      font-family: 'Orbitron', sans-serif;
      color: var(--neon-main);
      font-size: 24px;
      font-weight: 800;
      text-shadow: var(--neon-shadow);
      margin-bottom: 20px;
  }
  .btn-modern {
      padding: 12px 15px;
      border-radius: 25px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);
  }
  .btn-login-primary {
      background: var(--accent);
      color: #021;
      border: 1px solid var(--accent);
  }
  .btn-login-primary:hover {
      background: #00ff99;
      box-shadow: 0 0 18px #00ff99;
  }
  .btn-register {
      background: transparent;
      color: var(--neon-main);
      border: 1px solid var(--neon-main);
  }
  .btn-register:hover {
      background: rgba(0, 234, 255, 0.15);
      box-shadow: 0 0 12px var(--neon-glow);
  }
  /* END LOGIN MODAL */

  /* --- NEW MODAL CSS (TUGAS DEPOSIT) --- */
  .modalBox {
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.85);
    align-items:center;
    justify-content:center;
    z-index:99999;
  }
  .modalCard {
    background:#0b151b;
    padding:20px;
    border-radius:12px;
    width:90%;
    max-width:350px;
    background: linear-gradient(145deg, #010808, #051a1a);
    border: 1px solid rgba(0, 208, 132, 0.3);
    box-shadow: 0 4px 20px rgba(0, 208, 132, 0.3);
  }
  /* --- END NEW MODAL CSS --- */
  
  /* helper colors */
  .pnl-pos{color:var(--accent);font-weight:800}
  .pnl-neg{color:var(--danger);font-weight:800}
  /* custom PNL colors */
  .pnl-green{color:#00FF00;font-weight:800}
  .pnl-red{color:#FF4747;font-weight:800}
  .pnl-neutral{color:#e6eef2;font-weight:800}
  /* compact */
  .row{display:flex;gap:8px;align-items:center}
  .col{flex:1}
  .mini{font-size:12px;color:var(--muted)}
  .logo-sm{width:34px;height:34px;border-radius:8px;background:linear-gradient(135deg,var(--accent-2),var(--accent));display:flex;align-items:center;justify-content:center;font-weight:800; color: #021; box-shadow: 0 0 5px rgba(0, 234, 255, 0.5);}
  
  /* --- NEW HOME CSS --- */
  .home-profile {
      padding: 20px;
      display: flex;
      justify-content: center;
  }
  .home-card {
      background: linear-gradient(145deg, #0a1b12, #0d2a1b);
      padding: 22px;
      border-radius: 14px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 0 25px rgba(0,255,128,0.3);
      border: 1px solid rgba(0,255,120,0.4);
  }
  .home-avatar {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 50%;
      border: 3px solid #00ff80;
      box-shadow: 0 0 15px rgba(0,255,128,0.5);
      margin-bottom: 15px;
      margin-left: auto;
      margin-right: auto;
      display: block;
  }
  .home-info {
      text-align: center;
  }
  .home-name {
      font-size: 24px;
      font-weight: bold;
      color: #00ff95;
      text-shadow: 0 0 5px rgba(0, 255, 149, 0.5);
  }
  .home-role {
      font-size: 14px;
      opacity: 0.8;
      color: var(--accent-2);
  }
  .home-desc {
      font-size: 15px;
      margin-top: 10px;
      opacity: 0.9;
      line-height: 1.6;
  }
  /* --- END NEW HOME CSS --- */

  /* --- NEW BERANDA MENU CSS (PENAMBAHAN BARU) --- */
  .beranda-menu {
      padding: 0 12px;
      margin-top: 20px;
  }
  .beranda-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 20px;
      font-weight: 800;
      color: var(--accent-2);
      text-align: center;
      margin-bottom: 20px;
      text-shadow: var(--neon-shadow);
  }
  .lisensi-wrap {
      display: flex;
      justify-content: space-around;
      align-items: center;
      background: linear-gradient(90deg, rgba(0,0,0,0.1) 0%, rgba(0, 234, 255, 0.08) 50%, rgba(0,0,0,0.1) 100%);
      padding: 20px;
      border-radius: 15px;
      border: 1px solid rgba(0, 234, 255, 0.2);
      box-shadow: 0 0 15px rgba(0, 234, 255, 0.1);
  }
  .lisensi-img {
      width: 60px;
      height: 60px;
      object-fit: contain;
      opacity: 0.7;
      filter: drop-shadow(0 0 5px rgba(0, 234, 255, 0.7));
      transition: opacity 0.3s ease, transform 0.3s ease;
  }
  .lisensi-img:hover {
      opacity: 1;
      transform: scale(1.1);
  }
  .promo-card {
      background: linear-gradient(145deg, #091a0f, #07120a);
      margin: 12px;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid rgba(0, 208, 132, 0.4);
      box-shadow: 0 4px 20px rgba(0, 208, 132, 0.3);
  }
  .promo-title {
      font-size: 18px;
      font-weight: 800;
      color: var(--accent);
      margin-bottom: 10px;
  }
  .promo-text {
      font-size: 14px;
      line-height: 1.6;
      color: var(--muted);
  }
  /* --- END NEW BERANDA MENU CSS --- */

  /* --- MARKET (CRYPTO) TABLE CSS - MODIFIED --- */
  .crypto-market-card {
      background: linear-gradient(180deg,rgba(255,255,255,0.02),transparent);
      padding: 12px;
      border-radius: 10px;
      margin: 12px;
      border: 1px solid rgba(255,255,255,0.03);
  }
  .crypto-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed; /* Membuat lebar kolom tetap */
  }
  .crypto-table th {
      text-align: left;
      font-size: 13px;
      color: var(--muted);
      padding: 10px 8px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  .crypto-table td {
      padding: 12px 8px;
      border-bottom: 1px solid rgba(255,255,255,0.03);
      vertical-align: middle;
  }
  .crypto-table tr:last-child td {
      border-bottom: none;
  }
  .crypto-name {
      font-weight: 800;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 8px;
  }
  .crypto-price-realtime {
      font-weight: 800;
      font-size: 15px;
      transition: color 0.1s; /* Animasi kedipan harga */
  }

  .crypto-action-btn {
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s;
      border: none;
      width: 100%;
      min-width: 60px;
  }
  .btn-buy-crypto { background: var(--stock-buy); color: #021; }
  .btn-buy-crypto:hover { background: #00ffc7; box-shadow: 0 0 8px #00ffc7; }
  .btn-sell-crypto { background: var(--stock-sell); color: #fff; }
  .btn-sell-crypto:hover { background: #ff7087; box-shadow: 0 0 8px #ff7087; }
  /* Logo Placeholder untuk Crypto */
  .crypto-logo {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 800;
    color: #021;
  }

  /* --- END MARKET (CRYPTO) TABLE CSS --- */

  /* --- ADDED TOP MOVERS CSS (TUGAS 2) --- */
.top-movers {
    margin-top: 20px;
    padding: 15px;
    background: #0d1117;
    border-radius: 12px;
}

.title-tm {
    color: #ffffff;
    font-size: 20px;
    margin-bottom: 15px;
    font-weight: bold;
    font-family: 'Orbitron', sans-serif;
    text-shadow: 0 0 5px #0ecb81;
}

.mover-item {
    margin-bottom: 15px;
    padding: 5px 0;
}

.mover-header {
    display: flex;
    justify-content: space-between;
    color: #fff;
    font-size: 15px;
    margin-bottom: 5px;
    font-weight: 600;
}

.mover-bar {
    width: 100%;
    height: 10px;
    border-radius: 10px;
    transition: width 0.15s linear;
    box-shadow: 0 0 5px rgba(0,0,0,0.5);
}

.mover-green {
    background: #0ecb81;
    box-shadow: 0 0 8px rgba(14, 203, 129, 0.7);
}

.mover-red {
    background: #f6465d;
    box-shadow: 0 0 8px rgba(246, 70, 93, 0.7);
}
/* --- END ADDED TOP MOVERS CSS (TUGAS 2) --- */

/* --- START NEW SAHAM PAGE CSS (TUGAS BARU) --- */
.stock-list-container {
    padding: 12px;
    display: grid;
    gap: 12px;
}
.stock-group-title {
    font-family: 'Orbitron', sans-serif;
    font-size: 18px;
    font-weight: 800;
    color: var(--accent-2);
    margin-top: 20px;
    margin-bottom: 10px;
    padding: 0 12px;
    text-shadow: 0 0 5px var(--neon-glow);
}
.stock-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    border-radius: 10px;
    transition: background 0.2s, transform 0.2s;
    cursor: pointer;
}
.stock-item:hover {
    background: rgba(0, 234, 255, 0.05);
    transform: translateY(-2px);
}
.stock-info {
    display: flex;
    align-items: center;
    gap: 12px;
}
.stock-info b {
    font-size: 16px;
    font-weight: 800;
    color: #fff;
}
.stock-info span {
    font-size: 12px;
    color: var(--muted);
    display: block;
    margin-top: 2px;
}
.stock-price {
    text-align: right;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
}
.stock-price .price {
    font-weight: 800;
    font-size: 16px;
    margin-bottom: 2px;
}
.stock-change {
    font-size: 14px;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 8px;
    min-width: 70px;
    text-align: center;
}
.gain {
    color: var(--stock-buy);
    background: rgba(0, 255, 153, 0.15);
}
.loss {
    color: var(--stock-sell);
    background: rgba(255, 71, 71, 0.15);
}
/* New Card Style for Saham */
.stock-card {
    background: linear-gradient(145deg, #0d151c, #090e12);
    border: 1px solid rgba(0, 234, 255, 0.2);
    box-shadow: 0 4px 25px rgba(0, 0, 0, 0.4);
}

/* Stock Portfolio */
.portfolio-summary {
    background: linear-gradient(135deg, #0f1c2b, #07121c);
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 15px;
    border: 1px solid rgba(0, 234, 255, 0.3);
    box-shadow: 0 0 15px rgba(0, 234, 255, 0.2);
}
.portfolio-summary .pnl-green { color: #00FF00; }
.portfolio-summary .pnl-red { color: #FF4747; }
.stock-logo {
    width: 38px;
    height: 38px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 800;
    color: #fff;
    box-shadow: 0 0 8px rgba(255,255,255,0.3);
}

/* Logo Saham Placeholder/Simulasi - PENTING: Ganti dengan Gambar Asli di lingkungan Nyata */
.logo-bbca { background-color: #005696; color: #fff; } /* Biru BCA */
.logo-bbri { background-color: #FF9900; color: #000; } /* Kuning BRI */
.logo-tlkm { background-color: #FF0000; color: #fff; } /* Merah Telkom */
.logo-asii { background-color: #0066CC; color: #fff; } /* Biru Astra */
.logo-goto { background-color: #5A9E58; color: #fff; } /* Hijau GoTo */
.logo-icbp { background-color: #33CCFF; color: #000; } /* Biru Muda ICBP */
.logo-klbf { background-color: #009900; color: #fff; } /* Hijau Kalbe */
.logo-adro { background-color: #800000; color: #fff; } /* Merah Tua Adaro */
.logo-aapl { background-color: #A2AAAD; color: #000; } /* Abu Apple */
.logo-msft { background-color: #F25022; color: #fff; } /* Merah Microsoft */
.logo-nvda { background-color: #76B900; color: #fff; } /* Hijau Nvidia */
.logo-amzn { background-color: #FF9900; color: #000; } /* Kuning Amazon */
.logo-googl { background-color: #4285F4; color: #fff; } /* Biru Google */
.logo-meta { background-color: #0078FF; color: #fff; } /* Biru Meta */
.logo-tsla { background-color: #CC0000; color: #fff; } /* Merah Tesla */

/* --- END NEW SAHAM PAGE CSS (TUGAS BARU) --- */

/* --- STOCK ORDER MODAL CSS (UPDATED) --- */
#modalStockOrder {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.95); /* Lebih gelap untuk fokus */
    align-items: center;
    justify-content: center;
    z-index: 100000;
    padding: 10px;
}

.stock-order-card {
    background: linear-gradient(145deg, #010808, #051a1a);
    padding: 15px;
    border-radius: 12px;
    width: 95%;
    max-width: 900px; /* Lebar lebih besar */
    height: 95vh;
    border: 1px solid var(--accent);
    box-shadow: 0 0 30px rgba(0, 208, 132, 0.4);
    display: flex;
    flex-direction: column;
}

.stock-order-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}

.stock-order-title {
    font-family: 'Orbitron', sans-serif;
    color: var(--accent);
    font-size: 20px;
    font-weight: 800;
    text-shadow: 0 0 8px rgba(0, 208, 132, 0.7);
}

.stock-order-main {
    flex: 1;
    display: flex;
    flex-direction: column; /* Default untuk mobile */
    gap: 15px;
    overflow: hidden;
    padding-top: 15px;
}

@media(min-width: 768px) {
    .stock-order-main {
        flex-direction: row;
    }
}

.stock-chart-panel {
    flex: 3;
    display: flex;
    flex-direction: column;
    min-height: 40vh; /* Untuk mobile */
    max-height: 65vh;
}

@media(min-width: 768px) {
    .stock-chart-panel {
        min-height: 100%;
        max-height: 100%;
    }
}

.stock-order-panel {
    flex: 2;
    min-width: 300px;
    max-width: 100%;
    display: flex;
    flex-direction: column;
}

/* Stock Price Display in Modal */
.stock-price-box {
    padding: 10px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    margin-bottom: 15px;
}
.price-main-display {
    font-size: 32px;
    font-weight: 800;
    color: var(--neon-main);
    text-shadow: var(--neon-shadow);
}
.price-change-display {
    font-size: 16px;
    font-weight: 600;
    margin-top: 5px;
}

/* Stock Sub Menu */
.stock-sub-nav {
    display: flex;
    gap: 10px;
    margin-top: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    overflow-x: auto;
}
.stock-sub-nav button {
    background: transparent;
    border: none;
    color: var(--muted);
    padding: 8px 12px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.2s;
    border-radius: 6px;
    white-space: nowrap;
}
.stock-sub-nav button.active {
    color: var(--accent-2);
    background: rgba(0, 234, 255, 0.1);
    box-shadow: 0 0 8px rgba(0, 234, 255, 0.3);
}

.stock-sub-content {
    flex: 1;
    overflow-y: auto;
    padding-top: 10px;
}

/* Orderbook styles */
.orderbook-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
}
.orderbook-table th {
    text-align: left;
    color: var(--muted);
    padding: 5px 0;
}
.orderbook-table td {
    padding: 2px 0;
    font-weight: 600;
    position: relative;
}
.orderbook-table .price-col {
    width: 30%;
    text-align: center;
}
.orderbook-table .volume-col {
    width: 70%;
    text-align: right;
}
.order-buy-price {
    color: var(--stock-buy);
    background: var(--buy-bg-light);
}
.order-sell-price {
    color: var(--stock-sell);
    background: var(--sell-bg-light);
}
.order-buy-bar, .order-sell-bar {
    position: absolute;
    top: 0;
    height: 100%;
    opacity: 0.3;
    z-index: 1;
}
.order-buy-bar {
    right: 0;
    background: var(--stock-buy);
}
.order-sell-bar {
    left: 0;
    background: var(--stock-sell);
}
.orderbook-table td > span {
    position: relative;
    z-index: 2;
}

/* Tombol Beli/Jual di Modal */
.btn-buy-stock {
    background: var(--stock-buy);
    color: #021;
    font-weight: 800;
}
.btn-buy-stock:hover {
    box-shadow: 0 0 15px var(--stock-buy);
}

.btn-sell-stock {
    background: var(--stock-sell);
    color: #fff;
    font-weight: 800;
}
.btn-sell-stock:hover {
    box-shadow: 0 0 15px var(--stock-sell);
}

/* Close Button */
.btn-close-modal {
    background: rgba(255, 255, 255, 0.05);
    color: var(--muted);
    padding: 5px 10px;
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s;
}
.btn-close-modal:hover {
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
}
/* --- END STOCK ORDER MODAL CSS --- */
</style>
</head>
<body>

<div id="intro" class="intro">
  <div class="splash-logo-placeholder">D4</div>
  
  <div class="splash-text-wrap">
    <div class="splash-main-text">DEWA4</div>
    <div class="splash-sub-text">EXCHANGE</div>
  </div>
  <small class="loading-msg" style="margin-top:20px;">Loading Rill Market...</small>
</div>
<div class="app" id="app" style="display:none">
  <header class="main">
    <div style="display:flex;align-items:center;gap:12px">
      <div class="logo-sm">D4</div>
      <div class="brand">DEWA4EXCHANGE</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <div class="pill" id="uiNet">Rp 0</div>
      <button id="loginBtnTop" class="btn">Login ‚ñæ</button>
    </div>
  </header>

  <main id="mainContent">
    </main>

</div>

<nav class="bottom-nav" id="bottomNav" style="display:none">
  <div class="nav-item active" data-page="home" onclick="navTo('home')">
    <div>üè†</div><div>Beranda</div>
  </div>
  <div class="nav-item" data-page="market" onclick="navTo('market')">
    <div>‚Çø</div><div>Crypto</div>
  </div>
  <div class="nav-item" data-page="trade" onclick="navTo('trade')">
    <div>‚ö°</div><div>Futures</div>
  </div>
  <div class="nav-item" data-page="stocks" onclick="navTo('stocks')">
    <div>üè¶</div><div>Saham</div>
  </div>
  <div class="nav-item" data-page="wallet" onclick="navTo('wallet')">
    <div>üëõ</div><div>Aset</div>
  </div>
</nav>

<div id="loginModal">
  <div class="login-card">
    <div class="login-logo-sm">D4</div>
    <div class="login-title">DEWA4EXCHANGE</div>
    <div class="small" style="text-align:center;margin-top:-10px">Akun tersimpan di browser (localStorage) ‚Äî edukasi saja.</div>
    <div style="margin-top:16px">
      <input id="loginUser" placeholder="Username">
      <input id="loginPass" placeholder="Password" type="password" style="margin-top:12px">
      <div style="display:flex;gap:10px;margin-top:25px">
        <button class="btn-modern btn-login-primary" id="doLogin" style="flex:1">MASUK</button>
        <button class="btn-modern btn-register" id="doRegister" style="flex:1">DAFTAR</button>
      </div>
      <div style="display:flex;gap:8px;margin-top:15px">
        <button class="btn" id="closeLogin" style="flex:1;background:rgba(255,255,255,0.05)">Tutup</button>
        <button class="btn" id="quickGuest" style="flex:1;background:rgba(0, 234, 255, 0.1);color:var(--neon-main)">Quick Guest</button>
      </div>
      <div class="mini" style="margin-top:10px;text-align:center">Tip: Gunakan Quick Guest untuk mencoba dengan cepat.</div>
    </div>
  </div>
</div>

<div id="modalDepNominal" class="modalBox">
  <div class="modalCard">
    <h3 style="margin-top:0; color:var(--accent); text-align:center;">Deposit</h3>
    <p class="small" style="text-align:center;">Masukkan nominal deposit minimal Rp 100.000</p>
    <input id="depNominalInput" type="number" placeholder="100000" style="margin-top:10px;">
    <button class="btn-modern btn-login-primary" onclick="continueDepositQRIS()" style="width:100%;margin-top:15px">Lanjutkan</button>
    <button class="btn-modern" onclick="document.getElementById('modalDepNominal').style.display='none'" style="width:100%;margin-top:10px;background:rgba(255,255,255,0.05)">Batal</button>
  </div>
</div>

<div id="modalDepQRIS" class="modalBox">
  <div class="modalCard">
    <h3 style="margin-top:0; color:var(--accent); text-align:center;">Bayar Dengan QRIS</h3>
    <img src="https://i.ibb.co.com/MkTk59bx/Screenshot-20251203-203423-Google.jpg" style="width:100%;border-radius:10px;margin-top:10px;border:1px solid rgba(0, 234, 255, 0.2);">
    <p class="small" style="text-align:center;margin-top:15px">Total harus dibayar: <b id="textPendingDep" style="color:var(--accent-2)"></b></p>
    <button class="btn-modern btn-login-primary" onclick="finishDeposit()" style="width:100%;margin-top:15px">Saya Sudah Bayar</button>
    <button class="btn-modern" onclick="document.getElementById('modalDepQRIS').style.display='none'" style="width:100%;margin-top:10px;background:rgba(255,255,255,0.05)">Batal</button>
  </div>
</div>

<div id="modalStockOrder">
    <div class="stock-order-card">
        <div class="stock-order-header">
            <div style="display:flex;align-items:center;gap:10px;">
                <div class="stock-logo" id="stockOrderLogo"></div>
                <div class="stock-order-title" id="stockOrderTitle"></div>
            </div>
            <button class="btn-close-modal" onclick="document.getElementById('modalStockOrder').style.display='none'">Tutup</button>
        </div>
        
        <div class="stock-order-main">
            <div class="stock-chart-panel">
                <div class="stock-price-box">
                    <div class="price-main-display" id="stockOrderPrice">Rp 0</div>
                    <div class="price-change-display" id="stockOrderChange"></div>
                </div>
                
                <div class="stock-sub-nav" id="stockSubNav">
                    <button class="active" onclick="renderStockSubContent('Orderbook', this)">Orderbook</button>
                    <button onclick="renderStockSubContent('Trade', this)">Trade (Recent)</button>
                    <button onclick="renderStockSubContent('News', this)">News (Sim)</button>
                    <button onclick="renderStockSubContent('Analisis', this)">Analisis (Sim)</button>
                </div>

                <div class="stock-sub-content" id="stockSubContent">
                    </div>
            </div>

            <div class="stock-order-panel">
                <div class="small" style="margin-bottom: 10px; color: #ffeb3b;">Order Saham (Leverage: 1x - 100x)</div>
                
                <div style="margin-top:10px">
                    <label class="small">Harga Beli/Jual yang Diinginkan</label>
                    <input id="stockTargetPrice" type="number" placeholder="Contoh: 9300">
                </div>
                
                <div style="margin-top:12px">
                    <label class="small">Pilih Leverage (Maks. 100x)</label>
                    <select id="stockOrderLeverage">
                        <option value="1">1x (Saham Biasa)</option>
                        <option value="5">5x</option>
                        <option value="10">10x</option>
                        <option value="25">25x</option>
                        <option value="50">50x</option>
                        <option value="100">100x</option>
                    </select>
                </div>
                <div style="margin-top:12px">
                    <label class="small">Jumlah Unit/Lot (1 lot = 100 lembar)</label>
                    <input id="stockOrderUnits" type="number" placeholder="Contoh: 1 (lot)" value="1">
                </div>
                
                <div class="small" style="margin-top:15px; text-align:center; font-weight: 600;" id="stockOrderEstAmount">Total Estimasi: Rp 0</div>
                <div class="mini" style="text-align:center; color: #ffeb3b; margin-top:5px;" id="stockLeverageMessage">Leverage yang dipilih: 1x</div>
                
                <div style="display:flex; gap:10px; margin-top:25px;">
                    <button class="btn-modern btn-buy-stock" id="btnStockBuy" style="flex:1;">BELI (Buy)</button>
                    <button class="btn-modern btn-sell-stock" id="btnStockSell" style="flex:1;">JUAL (Sell)</button>
                </div>
                
                <div class="mini" style="text-align:center; margin-top:15px; color: var(--muted);">Peringatan: Perdagangan Leverage memiliki risiko kerugian yang tinggi.</div>
            </div>
        </div>
    </div>
</div>

<script src="https://s3.tradingview.com/tv.js"></script>
<script>
let tvWidget = null;

function loadMarketChart(pair) {
    // Mapping pair default (dari instruksi)
    const symbolMap = {
        "BTC/USDT": "BINANCE:BTCUSDT",
        "ETH/USDT": "BINANCE:ETHUSDT",
        "BNB/USDT": "BINANCE:BNBUSDT",
        "SOL/USDT": "BINANCE:SOLUSDT",
        "XRP/USDT": "BINANCE:XRPUSDT",
        "BBCA:IDX": "IDX:BBCA", // Simbol TradingView (Mungkin perlu TradingView berbayar/lisensi untuk IDX)
        "AAPL:NASDAQ": "NASDAQ:AAPL",
        "TSLA:NASDAQ": "NASDAQ:TSLA",
        // ... tambahkan mapping Saham lain jika simbol TradingView valid
    };
    
    // Fallback ke BINANCE:BTCUSDT jika tidak ada mapping yang ditemukan
    const symbol = symbolMap[pair] || PAIRS.find(p => p === pair) || "BINANCE:BTCUSDT";

    if (tvWidget) {
        if (tvWidget.remove) {
            tvWidget.remove();
        }
    }
    
    // Inisialisasi TradingView.widget yang baru
    tvWidget = new TradingView.widget({
        "width": "100%",
        "height": "100%", // Mengisi kontainer penuh
        "symbol": symbol,
        "interval": "D", // Interval default untuk Saham/Futures
        "timezone": "Asia/Jakarta",
        "theme": "dark",
        "style": "1",
        "locale": "id",
        "toolbar_bg": "#0d1117",
        "enable_publishing": false,
        "allow_symbol_change": true,
        "container_id": "stockSubChart" // ID container yang baru
    });
}

document.addEventListener("DOMContentLoaded", function () {
    // Fungsi ini akan dipanggil ulang di renderMarket()
});
</script>
<script>
/* ========== CONFIG (UPDATED: Tambah Saham) ========== */
const FX_IDR_PER_USD = 15000;
const DEFAULT_BAL = 0;
const STORAGE_USERS = 'db_Rill_users';
const STORAGE_CUR = 'db_Rill_current';
// UPDATED: Tambahkan lebih banyak saham, termasuk NASDAQ
const PAIRS = [
    'BTC/USDT','ETH/USDT','BNB/USDT','SOL/USDT', 'XRP/USDT', 'DOGE/USDT',
    'TSLA:NASDAQ','SPX:INDEX',
    'BBCA:IDX','BBRI:IDX','TLKM:IDX','ASII:IDX','GOTO:IDX','ICBP:IDX','KLBF:IDX', 'ADRO:IDX',
    'AAPL:NASDAQ','MSFT:NASDAQ','NVDA:NASDAQ','AMZN:NASDAQ','GOOGL:NASDAQ','META:NASDAQ'
];
const CRYPTO_PAIRS = ['BTC/USDT','ETH/USDT','BNB/USDT','SOL/USDT', 'XRP/USDT', 'DOGE/USDT'];
const MIN_DEPOSIT = 100000;
const STOCK_LOT_SIZE = 100;
const STOCK_LEVERAGE = 1;

/* ========== HELPERS ========== */
const $ = id => document.getElementById(id);
function fmtRp(x){ return 'Rp ' + Number(x).toLocaleString('id-ID'); }
function fmtUsd(x){ return '$ ' + Number(x).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

function toast(msg, t=2200){ const d=document.createElement('div'); d.style.position='fixed';d.style.right='12px';d.style.bottom='82px';d.style.background='rgba(0,0,0,0.75)';d.style.padding='8px 12px';d.style.borderRadius='8px';d.style.color='#fff';d.textContent=msg;document.body.appendChild(d); setTimeout(()=>d.remove(),t); return d; }

/* localStorage users */
function loadUsers(){ try { return JSON.parse(localStorage.getItem(STORAGE_USERS)||'{}'); } catch(e){ return {}; } }
function saveUsers(u){ localStorage.setItem(STORAGE_USERS, JSON.stringify(u)); }
function setCurrent(u){ localStorage.setItem(STORAGE_CUR, u||''); }
function getCurrent(){ return localStorage.getItem(STORAGE_CUR) || ''; }

/* PNL calculation */
function calcPnl(position, currentPrice){
  let diff = 0;
  const isStockIDX = position.pair.endsWith(':IDX');
  const isStockUS = position.pair.endsWith(':NASDAQ') || position.pair.endsWith(':INDEX');
  const isCrypto = position.pair.includes('USDT')||position.pair.includes('USD');
  
  const fx = isStockIDX ? 1 : (isCrypto ? FX_IDR_PER_USD : FX_IDR_PER_USD); 

  if(position.side === 'Buy'){
    diff = currentPrice - position.entryPrice;
  } else { // Sell
    diff = position.entryPrice - currentPrice;
  }

  let pnlIDR = 0;
  const effectiveLeverage = position.leverage || 1; 

  if (isStockIDX) {
    pnlIDR = diff * position.units * STOCK_LOT_SIZE * effectiveLeverage;
  } else if (isStockUS || isCrypto) {
    // Saham US/Index/Crypto: PnL * units * FX_IDR_PER_USD * leverage (USD asset)
    pnlIDR = diff * position.units * fx * effectiveLeverage;
  } else {
    // Fallback/Others
    pnlIDR = diff * position.units * FX_IDR_PER_USD * effectiveLeverage;
  }

  // Pnl USD untuk tampilan di UI
  // const pnlUSD = diff * position.units * effectiveLeverage; 
  const pnlPercent = (pnlIDR / position.amountIDR) * 100;

  return { pnlUSD: diff * position.units * effectiveLeverage, pnlIDR: Math.round(pnlIDR), pnlPercent };
}
function getPnlColorClass(pnlIDR){
  if(pnlIDR > 0) return 'pnl-green';
  if(pnlIDR < 0) return 'pnl-red';
  return 'pnl-neutral';
}
function fmtPnlPercent(pnlPercent){
  const sign = pnlPercent >= 0 ? '+' : '';
  return `(${sign}${pnlPercent.toFixed(2)}%)`;
}

/* ========== SIM PRICES (fallback) (UPDATED: Tambah Crypto/Saham) ========== */
const simSeries = {}; 
const volMap = {
    'BTC/USDT':700,'ETH/USDT':30,'BNB/USDT':1.5,'SOL/USDT':0.8, 'XRP/USDT':0.005, 'DOGE/USDT':0.0001,
    'TSLA:NASDAQ':2.5,'SPX:INDEX':1.2,
    'BBCA:IDX':90,'BBRI:IDX':50,'TLKM:IDX':40,'ASII:IDX':50,'GOTO:IDX':3,'ICBP:IDX':100,'KLBF:IDX':20,'ADRO:IDX':60,
    'AAPL:NASDAQ':3,'MSFT:NASDAQ':4,'NVDA:NASDAQ':15,'AMZN:NASDAQ':3.5,'GOOGL:NASDAQ':5,'META:NASDAQ':7
};
const baseMap = {
    'BTC/USDT':85000,'ETH/USDT':3400,'BNB/USDT':600,'SOL/USDT':135, 'XRP/USDT':0.5, 'DOGE/USDT':0.15,
    'TSLA:NASDAQ':320,'SPX:INDEX':4300,
    'BBCA:IDX':9200,'BBRI:IDX':4800,'TLKM:IDX':4000,'ASII:IDX':5000,'GOTO:IDX':80,'ICBP:IDX':11000,'KLBF:IDX':1500,'ADRO:IDX':2800,
    'AAPL:NASDAQ':195,'MSFT:NASDAQ':412,'NVDA:NASDAQ':900,'AMZN:NASDAQ':185,'GOOGL:NASDAQ':175,'META:NASDAQ':480
};
function genSim(pair){
  const arr=[]; let p = baseMap[pair]||100;
  for(let i=0;i<200;i++){ 
    const isIDX = pair.endsWith(':IDX');
    const o=p+(Math.random()-0.5)*(volMap[pair]||1); 
    const c=o+(Math.random()-0.5)*(volMap[pair]||1); 
    const final_o = Math.max(o, isIDX ? 1 : 0.0001);
    const final_c = Math.max(c, isIDX ? 1 : 0.0001);
    arr.push({o:final_o,c:final_c,h:Math.max(final_o,final_c)+Math.random(),l:Math.min(final_o,final_c)-Math.random()}); 
    p=final_c; 
  }
  simSeries[pair]=arr;
}
PAIRS.forEach(p=>genSim(p));

/* Stock data for Saham page (updated to use sim data) */
function getStockDataFromSim(ticker) {
    const pair = PAIRS.find(p => p.startsWith(ticker + ':'));
    if (!pair) return null;

    const sim = simSeries[pair];
    const lastPrice = sim ? (sim[sim.length-1].o + sim[sim.length-1].c)/2 : baseMap[pair];
    const prevPrice = sim ? (sim[sim.length-2].o + sim[sim.length-2].c)/2 : baseMap[pair];
    const change = ((lastPrice - prevPrice) / prevPrice) * 100;
    
    const currency = pair.endsWith(':IDX') ? 'IDR' : 'USD';
    const nameMap = {
        "BBCA": "Bank Central Asia Tbk.", "BBRI": "Bank Rakyat Indonesia Tbk.",
        "TLKM": "Telkom Indonesia (Persero) Tbk.", "ASII": "Astra International Tbk.",
        "GOTO": "GoTo Gojek Tokopedia Tbk.", "ICBP": "Indofood CBP Sukses Makmur Tbk.",
        "KLBF": "Kalbe Farma Tbk.", "ADRO": "Adaro Energy Indonesia Tbk.",
        "AAPL": "Apple Inc.", "MSFT": "Microsoft Corp.", "NVDA": "NVIDIA Corp.",
        "TSLA": "Tesla, Inc.", "AMZN": "Amazon.com, Inc.",
        "GOOGL": "Alphabet Inc. (Class A)", "META": "Meta Platforms, Inc.",
        "SPX": "S&P 500 Index"
    };
    
    // UPDATED: Stock Logo Placeholder Colors & Class
    const logoMap = {
        "BBCA": { text: "BCA", class: "logo-bbca" }, 
        "BBRI": { text: "BRI", class: "logo-bbri" },
        "TLKM": { text: "TLK", class: "logo-tlkm" }, 
        "ASII": { text: "AST", class: "logo-asii" },
        "GOTO": { text: "GTO", class: "logo-goto" }, 
        "ICBP": { text: "IBP", class: "logo-icbp" },
        "KLBF": { text: "KLB", class: "logo-klbf" }, 
        "ADRO": { text: "ADR", class: "logo-adro" },
        "AAPL": { text: "APL", class: "logo-aapl" }, 
        "MSFT": { text: "MSF", class: "logo-msft" },
        "NVDA": { text: "NVD", class: "logo-nvda" }, 
        "AMZN": { text: "AMZ", class: "logo-amzn" },
        "TSLA": { text: "TSL", class: "logo-tsla" }, 
        "GOOGL": { text: "GOG", class: "logo-googl" },
        "META": { text: "MET", class: "logo-meta" }
    };
    const logo = logoMap[ticker] || { text: ticker.slice(0, 3), class: "" };


    return {
        ticker: ticker,
        name: nameMap[ticker] || nameMap[pair] || ticker,
        price: parseFloat(lastPrice.toFixed(currency === 'IDR' ? 0 : 2)),
        change: parseFloat(change.toFixed(2)),
        currency: currency,
        pair: pair,
        logo: logo
    };
}

// UPDATED: Tambahkan ticker saham baru
const ALL_STOCK_TICKERS = ["BBCA", "BBRI", "TLKM", "ASII", "GOTO", "ICBP", "KLBF", "ADRO", "AAPL", "MSFT", "NVDA", "AMZN", "GOOGL", "META", "TSLA"];
let ALL_STOCKS = [];
function updateAllStocksData() {
    ALL_STOCKS = ALL_STOCK_TICKERS.map(getStockDataFromSim).filter(s => s !== null);
}
updateAllStocksData(); // Initial load

function getStockByTicker(ticker) {
    return ALL_STOCKS.find(s => s.ticker === ticker) || ALL_STOCKS.find(s => s.pair.includes(ticker));
}

/* Try fetch price from Binance (only for symbols like BINANCE:BTCUSDT) */
async function fetchPriceBinance(symbol){
  try{
    const s = symbol.replace(/.*:/,'');
    const r = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=' + s);
    if(!r.ok) return null;
    const j = await r.json(); return Number(j.price);
  }catch(e){return null;}
}

/* get price (prefers remote for crypto when priceMode=realtime) */
async function getPrice(pair){
  const map = {'BTC/USDT':'BINANCE:BTCUSDT','ETH/USDT':'BINANCE:ETHUSDT','XRP/USDT':'BINANCE:XRPUSDT','BNB/USDT':'BINANCE:BNBUSDT','SOL/USDT':'BINANCE:SOLUSDT','DOGE/USDT':'BINANCE:DOGEUSDT'};
  
  if(pair.endsWith(':IDX') || pair.endsWith(':NASDAQ') || pair.endsWith(':INDEX')){
      const stock = getStockByTicker(pair.split(':')[0]);
      return stock ? stock.price : (simSeries[pair] ? (simSeries[pair][simSeries[pair].length-1].o + simSeries[pair][simSeries[pair].length-1].c)/2 : 0);
  }

  const sym = map[pair] || pair;
  if(window.priceMode === 'realtime' && (sym.includes('BINANCE'))){
    const r = await fetchPriceBinance(sym);
    if(r) return r;
  }
  const s = simSeries[pair]; 
  if(!s || s.length === 0) return baseMap[pair] || 0;
  const last = s[s.length-1]; 
  return (last.o + last.c)/2;
}

/* AI Signal & PnL Adjustment */
let aiSignals = {};
function getAISignal(pair) {
    if (!aiSignals[pair]) {
        // Initial random signal
        const r = Math.random();
        aiSignals[pair] = r < 0.4 ? 'Buy' : (r < 0.8 ? 'Sell' : 'Hold');
    }
    return aiSignals[pair];
}

function updateAISignals() {
    CRYPTO_PAIRS.forEach(pair => {
        // 40% chance to flip signal
        if (Math.random() < 0.4) {
            const current = aiSignals[pair];
            const r = Math.random();
            if (current === 'Buy') {
                aiSignals[pair] = r < 0.6 ? 'Buy' : (r < 0.8 ? 'Sell' : 'Hold'); // Tend to keep Buy
            } else if (current === 'Sell') {
                aiSignals[pair] = r < 0.6 ? 'Sell' : (r < 0.8 ? 'Buy' : 'Hold'); // Tend to keep Sell
            } else { // Hold
                aiSignals[pair] = r < 0.4 ? 'Buy' : (r < 0.8 ? 'Sell' : 'Hold'); // Random flip from Hold
            }
        }
    });
}
// Panggil di marketLoop
updateAISignals(); 

function getSignalPriceAdjustment(pair, side, currentPrice) {
    const signal = getAISignal(pair);
    let adjustment = 0;
    const vol = volMap[pair] || 1;
    
    // Potensi keuntungan/kerugian awal yang kecil (misalnya 0.05% dari harga)
    const baseAdjustment = currentPrice * 0.0005;

    if (side === signal) {
        // Sesuai sinyal AI: Peluang profit 65% (adjustedEntryPrice lebih rendah/lebih tinggi)
        if (Math.random() < 0.65) {
            adjustment = side === 'Buy' ? -baseAdjustment : baseAdjustment; // Entry price lebih baik
        } else {
            adjustment = side === 'Buy' ? baseAdjustment : -baseAdjustment; // Entry price lebih buruk
        }
    } else {
        // Lawan sinyal AI: Peluang loss 65%
        if (Math.random() < 0.65) {
            adjustment = side === 'Buy' ? baseAdjustment : -baseAdjustment; // Entry price lebih buruk
        } else {
            adjustment = side === 'Buy' ? -baseAdjustment : baseAdjustment; // Entry price lebih baik (menguntungkan)
        }
    }
    
    // Adjust entry price based on signal (simulasi)
    return currentPrice + adjustment;
}

/* ========== UI: SPA Navigation ========== */
let currentPage = 'home';
window.priceMode = 'sim'; // sim or realtime
const mainContent = $('mainContent');

function navTo(page, optionalData = {}){
  currentPage = page;
  // update bottom nav active
  document.querySelectorAll('.nav-item').forEach(n=> n.classList.toggle('active', n.dataset.page === page));
  renderPage(page, optionalData);
}

/* ========== PAGES ========== */
async function renderPage(page, optionalData){
  if(page==='home') return renderHome();
  if(page==='market') return renderMarket();
  if(page==='trade') return renderTrade(optionalData);
  if(page==='stocks') return renderStocks(); 
  if(page==='wallet') return renderWallet();
}

/* HOME */
function renderHome(){
  // START MODIFIED HOME CONTENT
  // PERUBAHAN: GANTI TAUTAN GAMBAR DI BAGIAN LISENSI
  mainContent.innerHTML = `
    <div class="home-profile">
        <div class="home-card">
            <img src="https://i.ibb.co.com/Y43GswQS/Screenshot-20251202-184042-Gallery.jpg"
     alt="CEO Dewa Exchange"
     style="
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        display: block;
        margin: 0 auto;
        border: 3px solid #00FF80;
        box-shadow: 0 0 20px #00FF80;
     ">
            <div class="home-info">
                <div class="home-name">Dewangga</div>
                <div class="home-role">Founder & CEO ‚Äî D4EXCHANGE</div>
                <div class="home-desc">
                    Selamat datang di D4EXCHANGE ‚Äî Platform jual beli saham/crypto.
                </div>
            </div>
        </div>
    </div>
    
    <section class="beranda-menu">
        <div class="beranda-title">LAYANAN & LISENSI TERPERCAYA</div>
        <div class="lisensi-wrap">
            <a href="https://ibb.co.com/dwySXCkR" target="_blank" rel="noopener noreferrer">
                <img src="https://i.ibb.co.com/dwySXCkR/Screenshot-20251207-191341-Google.jpg" 
                     alt="Lisensi BAPPEBTI" 
                     class="lisensi-img" border="0">
            </a>
            <a href="https://ibb.co.com/d4xVnRLk" target="_blank" rel="noopener noreferrer">
                <img src="https://i.ibb.co.com/d4xVnRLk/png-clipart-financial-services-authority-logo-jpeg-ojk-jember-text-trademark.png" 
                     alt="Lisensi OJK" 
                     class="lisensi-img" border="0">
            </a>
            <a href="https://ibb.co.com/7dkNfMQZ" target="_blank" rel="noopener noreferrer">
                <img src="https://i.ibb.co.com/7dkNfMQZ/c-Yk-D48-M3.png" 
                     alt="Lisensi ICDX" 
                     class="lisensi-img" border="0">
            </a>
        </div>
    </section>
    
    <div class="promo-card">
        <div class="promo-title">belajar dulu baru terjun</div>
        <div class="promo-text">
            D4EXCHANGE adalah platform edukasi revolusioner untuk mempelajari trading 
            aset digital, saham global, dan komoditas. Nikmati simulasi pergerakan harga real-time
            dengan modal virtual. Latih strategi Anda, pahami risiko, dan siap
            melangkah ke pasar riil! Semua data saldo di sini adalah RILL (simulasi)
            dan tidak melibatkan dana sungguhan.
        </div>
    </div>
    <div class="grid" style="margin-top:12px; display:none;">
      <div>
        <div class="card" id="hiddenHomeCard1">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="small">Market</div>
              <div style="font-weight:800" id="marketLabelHome">BTC/USDT</div>
            </div>
            <div style="text-align:right">
              <div id="priceMainHome" style="font-size:20px;font-weight:800">--</div>
              <div class="small" id="subPriceHome">--</div>
            </div>
          </div>
          <div style="height:220px;margin-top:10px;background:#07121a;border-radius:10px;overflow:hidden" id="homeChartWrap">
            </div>
          <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
            <div class="pill" id="hlInfoHome">H:- ‚Ä¢ L:-</div><div style="flex:1"></div><div class="small">Mode: <strong id="modeLabelHome"></strong></div>
          </div>
        </div>
        <div class="card" id="quickTradeCardHidden">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><div class="small">Quick Trade</div><div style="font-weight:800" id="qt_pair">BTC/USDT</div></div>
            <div><button class="btn btn-primary" onclick="navTo('trade')">Go to Trade</button></div>
          </div>
          <div style="margin-top:10px" class="small">Contoh Rill: lihat potensi PnL untuk <b>0.01 unit</b> (0.01 lot) di panel Trade.</div>
        </div>
      </div>
      <div>
        <div class="card" id="sideBalanceCard">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><div class="small">Saldo</div><div id="sideBalance" style="font-weight:800">Rp 0</div></div>
            <div><button class="btn" id="openDepBtnSide">Deposit</button></div>
          </div>
          <div style="margin-top:12px">
            <div class="small">Open Positions</div>
            <div class="positions" id="sidePositions">Belum ada posisi</div>
          </div>
        </div>
        <div class="card" id="sideMutasiCard">
          <div class="small">Riwayat / Mutasi</div>
          <div class="mutasi" id="sideMutasi">Belum ada mutasi</div>
        </div>
      </div>
    </div>
  `;
  // END MODIFIED HOME CONTENT
  // Tidak perlu lagi initTViframe di home, karena bagian ini disembunyikan
  // initTViframe('BTC/USDT', 'homeChartWrap');
  updateMarketHeaderDisplays('BTC/USDT');
  bindSideButtons();
  renderPositionsUI('sidePositions');
}

/* MARKET (CRYPTO) page (MODIFIED: Remove AI Signal) */
let cryptoInterval = null; // Untuk menyimpan interval update harga
const cryptoPairsData = {}; // Untuk menyimpan harga dan perubahan real-time

function getCryptoLogo(pair) {
    const symbol = pair.split('/')[0];
    const map = {
        'BTC': { text: 'B', bg: '#F7931A' }, 'ETH': { text: 'E', bg: '#627EEA' },
        'BNB': { text: 'B', bg: '#F3BA2F' }, 'SOL': { text: 'S', bg: '#9945FF' },
        'XRP': { text: 'X', bg: '#000000', color: '#fff' }, 'DOGE': { text: 'D', bg: '#C2A633' }
    };
    const logo = map[symbol] || { text: symbol.slice(0,1), bg: '#555' };
    logo.color = logo.color || '#021';
    return logo;
}

async function updateCryptoList() {
    const tableBody = document.getElementById('cryptoTableBody');
    if (!tableBody) return;

    for (const pair of CRYPTO_PAIRS) {
        const currentPrice = await getPrice(pair);
        
        let prevPrice = cryptoPairsData[pair] && cryptoPairsData[pair].price !== undefined ? cryptoPairsData[pair].price : baseMap[pair];
        
        // Cek jika harga baru terlalu jauh dari harga sebelumnya (misalnya 10%)
        if (prevPrice === baseMap[pair] || Math.abs(currentPrice - prevPrice) / prevPrice > 0.1) {
             // Jika data sebelumnya belum ada atau harga bergerak ekstrem, gunakan base price.
             // Di sini kita biarkan menggunakan harga sebelumnya yang tersimpan, atau baseMap untuk awal.
             if(cryptoPairsData[pair] && cryptoPairsData[pair].price !== undefined) {
                 prevPrice = cryptoPairsData[pair].price;
             }
        }

        const change = ((currentPrice - prevPrice) / prevPrice) * 100;
        
        // Simpan data untuk update berikutnya
        cryptoPairsData[pair] = { price: currentPrice, change: change };
    }
    
    // Render ulang tabel setelah semua harga di-fetch
    let html = '';
    for (const pair of CRYPTO_PAIRS) {
        const data = cryptoPairsData[pair];
        if (!data) continue; // Skip jika data belum siap
        
        const logo = getCryptoLogo(pair);
        const priceColor = data.change >= 0 ? 'pnl-green' : 'pnl-red';
        const priceDecimals = pair.includes('DOGE') || pair.includes('XRP') ? 4 : (pair.includes('BNB') || pair.includes('SOL') ? 2 : 0);
        
        html += `
            <tr data-pair="${pair}">
                <td style="width:30%;">
                    <div class="crypto-name">
                        <div class="crypto-logo" style="background:${logo.bg}; color:${logo.color};">${logo.text}</div>
                        ${pair}
                    </div>
                </td>
                <td style="text-align:right; width: 40%;">
                    <div class="crypto-price-realtime ${priceColor}" data-price="${pair}">
                        ${Number(data.price).toFixed(priceDecimals)}
                    </div>
                    <div class="small ${priceColor}" data-change="${pair}">
                        ${data.change >= 0 ? '+' : ''}${data.change.toFixed(2)}%
                    </div>
                </td>
                <td style="width: 30%;">
                    <div style="display:flex; gap:5px; justify-content: flex-end;">
                        <button class="crypto-action-btn btn-buy-crypto" onclick="openTradeDirect('${pair}', 'Buy')">Buy</button>
                        <button class="crypto-action-btn btn-sell-crypto" onclick="openTradeDirect('${pair}', 'Sell')">Sell</button>
                    </div>
                </td>
            </tr>
        `;
    }
    tableBody.innerHTML = html;
}

function renderMarket(){
  // Clear interval lama jika ada
  if (cryptoInterval) clearInterval(cryptoInterval);

  // Konten Halaman Crypto Baru
  mainContent.innerHTML = `
    <h2 class="beranda-title" style="margin-top:0; padding-top:10px;">PASAR CRYPTO FUTURES (SIM)</h2>
    
    <div class="crypto-market-card">
        <table class="crypto-table">
            <thead>
                <tr>
                    <th style="width:30%;">Pasangan</th>
                    <th style="text-align:right; width: 40%;">Harga (USD)</th>
                    <th style="text-align:right; width: 30%;">Aksi Cepat</th>
                </tr>
            </thead>
            <tbody id="cryptoTableBody">
                <tr><td colspan="3" style="text-align:center;">Memuat data Crypto...</td></tr>
            </tbody>
        </table>
    </div>

    <div class="card" style="margin-top:12px">
        <div class="top-movers fast-movers">
            <h3 class="title-tm">Top Movers (Sim)</h3>
            <div id="topMoversList"></div>
        </div>
    </div>
  `;
  
  // Inisialisasi dan set interval update
  updateCryptoList();
  cryptoInterval = setInterval(updateCryptoList, 1500); // Update setiap 1.5 detik
  renderTopMovers();
}

/* open trade direct dari menu crypto (MODIFIED: Navigate to Trade) */
function openTradeDirect(pair, side) {
    const cur = getCurrent();
    if (!cur) return alert('Silakan Login terlebih dahulu untuk melakukan perdagangan.');
    
    // Alihkan ke halaman Trade dan set pasangan
    navTo('trade', { preselectPair: pair });
    // Side tidak lagi langsung membuka posisi, pengguna harus mengklik Buy/Sell di halaman Trade
    toast(`Silakan atur Lot dan Leverage untuk ${pair} di menu Futures.`);
}


/* MARKET snapshot */
// Tidak digunakan lagi, dihapus untuk cleanup.

/* TRADE page (MODIFIED: Terima optionalData untuk preselectPair) */
function renderTrade(optionalData = {}){
  const preselectPair = optionalData.preselectPair || 'BTC/USDT';
  
  mainContent.innerHTML = `
    <div class="grid">
      <div>
        <div class="card">
          <div class="small">ORDER ‚Äî Open Position (Futures/Crypto)</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <div style="flex:1">
              <label class="small">Pair</label>
              <select id="pairSelectTrade">${CRYPTO_PAIRS.map(p=>`<option value="${p}" ${p === preselectPair ? 'selected' : ''}>${p}</option>`).join('')}</select>
            </div>
            <div style="width:120px">
              <label class="small">Leverage</label>
              <select id="leverageTrade"><option>1</option><option>2</option><option>5</option><option selected>10</option><option>25</option><option>50</option><option>100</option></select>
            </div>
          </div>

          <div style="display:flex;gap:8px;margin-top:8px">
            <div style="flex:1">
              <label class="small">Input</label>
              <select id="inputModeTrade"><option value="nominal">Nominal (IDR)</option><option value="units">Units</option></select>
            </div>
            <div style="width:140px">
              <label class="small">Amount</label>
              <input id="openAmountTrade" placeholder="Contoh: 200000" value="100000">
            </div>
          </div>

          <div style="display:flex;gap:8px;margin-top:12px">
            <button class="btn btn-primary" id="btnBuyTrade">Buy</button>
            <button class="btn" id="btnSellTrade">Sell</button>
            <div style="flex:1"></div>
            <div class="small" id="tradePriceInfo">--</div>
          </div>

          <div style="margin-top:10px" class="small">Estimasi PnL per 1 USD/IDR (sesuai aset) bergerak untuk 0.01 unit: <span id="estPnl">--</span></div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="small">Open Positions</div>
          <div class="positions" id="tradePositions">Belum ada posisi</div>
        </div>
      </div>

      <div>
        <div class="card">
          <div class="small">Portfolio (Futures)</div>
          <div id="tradePortfolio" style="margin-top:8px">Saldo Penuh Anda digunakan sebagai Margin Pool.</div>
        </div>

        <div class="card" style="margin-top:12px">
          <div class="small">Mutasi</div>
          <div class="mutasi" id="tradeMutasi">--</div>
        </div>
      </div>
    </div>
  `;
  // bind events
  updateTradePriceInfo();
  $('pairSelectTrade').onchange = updateTradePriceInfo;
  $('leverageTrade').onchange = updateTradePriceInfo; // update PnL estimation if leverage changes
  $('inputModeTrade').onchange = ()=> $('openAmountTrade').value='';
  $('btnBuyTrade').onclick = ()=> openPosition('Buy');
  $('btnSellTrade').onclick = ()=> openPosition('Sell');
  renderPositionsUI('tradePositions'); renderPortfolioUI(); renderMutasiUI('tradeMutasi');
}

/* SAHAM (STOCKS) page (MODIFIED: Use Logo Class) */
function renderStocks(){
  // Fungsi untuk membuat elemen saham
  const renderStockItem = (stock) => {
    const isGain = stock.change >= 0;
    const priceDisplay = stock.currency === 'IDR' ? stock.price.toLocaleString('id-ID') : stock.price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const currencySymbol = stock.currency === 'IDR' ? 'Rp' : '$';
    
    // Gunakan class logo baru
    const logoEl = `<div class="stock-logo ${stock.logo.class}"><span>${stock.ticker}</span></div>`;

    return `
      <div class="stock-item" onclick="openStockOrderModal('${stock.ticker}')"> 
        <div class="stock-info">
            ${logoEl}
            <div>
                <b>${stock.ticker}</b> (${stock.currency})
                <span>${stock.name}</span>
            </div>
        </div>
        <div class="stock-price">
          <span class="price ${isGain ? 'pnl-green' : 'pnl-red'}">${currencySymbol} ${priceDisplay}</span>
          <span class="stock-change ${isGain ? 'gain' : 'loss'}">${isGain ? '+' : ''}${stock.change}%</span>
        </div>
      </div>
    `;
  };
  
  updateAllStocksData(); // Ambil data saham terbaru
  const INDONESIAN_STOCKS = ALL_STOCKS.filter(s => s.pair.endsWith(':IDX'));
  const US_STOCKS_FX = ALL_STOCKS.filter(s => s.pair.endsWith(':NASDAQ') || s.pair.endsWith(':INDEX'));

  // Render daftar saham
  const idxList = INDONESIAN_STOCKS.map(renderStockItem).join('');
  const usList = US_STOCKS_FX.map(renderStockItem).join('');
  
  // Render Ringkasan Portfolio (ambil dari posisi yang ada)
  const cur = getCurrent();
  const data = cur ? loadUsers()[cur].data : null;
  let totalStockValueIDR = 0;
  let totalStockGainLossIDR = 0;
  
  if (data && data.positions && data.positions.length > 0) {
      data.positions.filter(p => p.pair.endsWith(':IDX') || p.pair.endsWith(':NASDAQ') || p.pair.endsWith(':INDEX')).forEach(p => {
          // Margin awal + PnL
          totalStockValueIDR += p.amountIDR; 
          totalStockGainLossIDR += (p.pnl || 0);
      });
  }

  const portfolioContent = `
    <div class="portfolio-summary">
        <div class="small" style="color:#fff;">Total Margin Saham Rill (Open)</div>
        <div style="font-weight:800; font-size:26px; color:#fff; margin:5px 0;">${fmtRp(totalStockValueIDR)}</div>
        <div class="small" style="color:#fff;">Total PnL (Open): <span class="${getPnlColorClass(totalStockGainLossIDR)}">${fmtRp(totalStockGainLossIDR)}</span></div>
        <button class="btn-primary" style="margin-top:15px; padding:8px 15px; font-size:14px; border-radius: 20px;" onclick="navTo('trade')">Buka Posisi Futures/Crypto</button>
    </div>
  `;
  
  mainContent.innerHTML = `
    <div class="stock-list-container">
        <div class="card stock-card" style="margin: 0 12px; padding: 0;">
            ${cur ? portfolioContent : '<div class="small" style="text-align:center; padding: 20px;">Silakan Login untuk melihat Portfolio Saham.</div>'}
        </div>
        
        <div class="stock-group-title" style="margin-top:10px;">SAHAM INDONESIA (IDX)</div>
        <div class="card stock-card" style="background:linear-gradient(145deg, #1f1028, #11081a);">
            ${idxList}
        </div>

        <div class="stock-group-title">SAHAM GLOBAL (US - NASDAQ/NYSE)</div>
        <div class="card stock-card" style="background:linear-gradient(145deg, #0e1a2b, #09121c);">
            ${usList}
        </div>

        <div class="card stock-card" style="margin: 12px;">
            <div class="small">Informasi: Saham yang tercantum adalah simulasi dan bukan harga pasar real-time. Untuk perdagangan saham, klik saham yang diinginkan. Anda dapat menggunakan leverage hingga 100x pada simulasi saham ini.</div>
        </div>
    </div>
  `;
}

/* WALLET */
function renderWallet(){
  mainContent.innerHTML = `
    <div class="grid">
      <div>
        <div class="card">
          <div class="small">Saldo</div>
          <div style="font-weight:800;font-size:24px;color:var(--accent-2);margin-top:8px" id="walletBalance">Rp 0</div>
          <div style="display:flex;gap:8px;margin-top:15px">
            <button class="btn btn-primary" id="depBtnWallet">Deposit</button>
            <button class="btn" id="witBtnWallet">Withdraw</button>
            <button class="btn" id="exportBtn">Export Mutasi</button>
          </div>
          <div class="small" style="margin-top: 10px; color: #ffeb3b;">Minimal Deposit: ${fmtRp(MIN_DEPOSIT)}</div> </div>

        <div class="card" style="margin-top:12px">
          <div class="small">Riwayat</div>
          <div class="mutasi" id="walletMutasi">Tidak ada mutasi</div>
        </div>
      </div>

      <div>
        <div class="card">
          <div class="small">Akun & Alamat (Rill)</div>
          <div style="margin-top:8px; font-weight:800;"><b id="walletUser">‚Äî</b></div>
          <div class="small" style="margin-top:8px">Alamat Wallet: <span id="walletAddr">‚Äî</span></div>
        </div>
      </div>
    </div>
  `;
  $('depBtnWallet').onclick = ()=> openDepositModal();
  $('witBtnWallet').onclick = ()=> openWithdrawModal();
  $('exportBtn').onclick = exportMutasi;
  renderWalletData();
  renderMutasiUI('walletMutasi');
}

/* ========== User / Session helpers ========== */
function loadCurrentData(){
  const cur = getCurrent();
  if(!cur) return null;
  const users = loadUsers();
  return users[cur] ? users[cur].data : null;
}
function ensureUserExists(u){
  const users = loadUsers();
  if(!users[u]) {
    users[u] = { pass:'', data:{ balance: DEFAULT_BAL, history:[], positions:[], portfolio:[], addr:'ADDR_'+Math.random().toString(36).slice(2,8) } };
    saveUsers(users);
  }
}

/* ========== Actions: positions, deposit, withdraw ========== */
let currentStockOrder = null;

// FUNGSI BARU: Mengganti konten sub-menu Saham
function renderStockSubContent(contentType, buttonElement) {
    const contentDiv = $('stockSubContent');
    const allButtons = $('stockSubNav').querySelectorAll('button');
    allButtons.forEach(btn => btn.classList.remove('active'));
    buttonElement.classList.add('active');
    
    // Hapus Chart TradingView jika ada, agar Orderbook/lainnya bisa ditampilkan
    if (tvWidget) {
        if (tvWidget.remove) {
            tvWidget.remove();
        }
        tvWidget = null; 
    }
    
    let html = '';
    const stock = currentStockOrder; 
    const isIDX = stock.currency === 'IDR';
    const priceDecimals = isIDX ? 0 : 2;
    const currencySymbol = isIDX ? 'Rp' : '$';

    switch (contentType) {
        case 'Orderbook':
            // Simulasi Orderbook
            const currentPrice = stock.price;
            const orders = [];
            const maxVol = isIDX ? 500 : 100;
            
            // Generate Sell Orders (Harga > Current Price)
            for(let i = 5; i >= 1; i--) {
                const price = currentPrice + (isIDX ? i * 50 : i * 0.5);
                const volume = Math.floor(Math.random() * maxVol) + 5;
                orders.push({ type: 'Sell', price: price.toFixed(priceDecimals), volume });
            }
            
            // Generate Buy Orders (Harga < Current Price)
            for(let i = 1; i <= 5; i++) {
                const price = currentPrice - (isIDX ? i * 50 : i * 0.5);
                const volume = Math.floor(Math.random() * maxVol) + 5;
                orders.push({ type: 'Buy', price: price.toFixed(priceDecimals), volume });
            }
            
            const maxGlobalVol = orders.reduce((max, o) => Math.max(max, o.volume), 0);
            
            // Render Tabel Orderbook
            html = `
                <table class="orderbook-table">
                    <thead>
                        <tr>
                            <th style="width:30%;">Harga (${currencySymbol})</th>
                            <th style="width:70%; text-align:right;">Volume (Lot/Unit)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Render Sell Orders
            orders.filter(o => o.type === 'Sell').sort((a, b) => b.price - a.price).forEach(o => {
                const widthPercent = (o.volume / maxGlobalVol) * 100;
                html += `
                    <tr style="cursor:pointer;" onclick="$('stockTargetPrice').value='${o.price}'">
                        <td class="price-col order-sell-price"><div class="order-sell-bar" style="width:${widthPercent}%"></div><span>${o.price}</span></td>
                        <td class="volume-col">${o.volume}</td>
                    </tr>
                `;
            });
            
            // Harga Saat Ini
            html += `
                <tr style="background:#07121a;">
                    <td colspan="2" style="font-size:16px; text-align:center; padding: 5px 0;">
                        <b class="${stock.change >= 0 ? 'pnl-green' : 'pnl-red'}">${currencySymbol} ${stock.price.toFixed(priceDecimals)}</b>
                    </td>
                </tr>
            `;
            
            // Render Buy Orders
            orders.filter(o => o.type === 'Buy').sort((a, b) => b.price - a.price).forEach(o => {
                const widthPercent = (o.volume / maxGlobalVol) * 100;
                html += `
                    <tr style="cursor:pointer;" onclick="$('stockTargetPrice').value='${o.price}'">
                        <td class="price-col order-buy-price"><div class="order-buy-bar" style="width:${widthPercent}%"></div><span>${o.price}</span></td>
                        <td class="volume-col">${o.volume}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            break;
        case 'Trade':
            // Simulasi Recent Trades (Trade History)
            html = `<div style="padding: 10px;">
                <h4 style="margin-top:0; color:var(--accent-2);">Riwayat Transaksi (Simulasi)</h4>
                <table style="width:100%; font-size:13px; border-collapse: collapse;">
                    <tr><th>Waktu</th><th>Harga</th><th>Lot/Unit</th></tr>
            `;
            for(let i = 0; i < 10; i++) {
                const p = stock.price + (Math.random() - 0.5) * (isIDX ? 100 : 1);
                const v = Math.floor(Math.random() * 50) + 1;
                const priceColor = Math.random() < 0.5 ? 'pnl-green' : 'pnl-red';
                const time = new Date(Date.now() - i * 60000).toLocaleTimeString();
                html += `<tr>
                    <td style="padding: 5px 0;">${time}</td>
                    <td class="${priceColor}">${p.toFixed(priceDecimals)}</td>
                    <td style="text-align:right;">${v}</td>
                </tr>`;
            }
            html += `</table></div>`;
            break;
        case 'News':
            // Simulasi News
            const news = [
                "Keuntungan Bank Sentral di Atas Ekspektasi Analis Pasar.",
                "Saham Teknologi Global Menguat Menyambut Data Inflasi AS.",
                "Rilis Laporan Keuangan Kuartal 4 ${stock.ticker} Diperkirakan Positif.",
                "Keputusan Suku Bunga Federal Reserve Memberikan Sentimen Positif.",
                "Analisis Teknikal: ${stock.ticker} Breakout dari Pola Segitiga."
            ];
            html = `<div style="padding: 10px;">
                <h4 style="margin-top:0; color:var(--accent-2);">Berita Terkini (Simulasi)</h4>
                ${news.map(n => `<div style="margin-bottom: 12px; border-bottom: 1px dashed rgba(255,255,255,0.05); padding-bottom: 5px;"><b style="color:#fff;">${n}</b><div class="mini">Sumber: D4X Research</div></div>`).join('')}
            </div>`;
            break;
        case 'Analisis':
            // Simulasi Analisis
            html = `<div style="padding: 10px;">
                <h4 style="margin-top:0; color:var(--accent-2);">Analisis Teknikal & Fundamental (Simulasi)</h4>
                <p class="small"><b>Rekomendasi Analis:</b> ${Math.random() > 0.6 ? 'Buy' : 'Hold'}</p>
                <p class="small"><b>Target Harga (1 Bulan):</b> ${currencySymbol} ${(stock.price * (1 + (Math.random() * 0.1))).toFixed(priceDecimals)}</p>
                <p class="small"><b>Support Kuat:</b> ${currencySymbol} ${(stock.price * 0.95).toFixed(priceDecimals)}</p>
                <p class="small" style="margin-top:10px;">Analisis menunjukkan bahwa ${stock.ticker} saat ini berada di zona akumulasi. Volume perdagangan (simulasi) telah meningkat dalam 3 sesi terakhir. Disarankan untuk memasang posisi buy terbatas dengan target jangka pendek.</p>
                <div id="stockSubChart" style="height:300px; margin-top: 15px;"></div>
            </div>`;
            // Memuat Chart TradingView di sini
            setTimeout(() => {
                loadMarketChart(stock.pair);
            }, 50); 
            break;
    }
    
    contentDiv.innerHTML = html;
}

// FUNGSI UTAMA: Membuka modal pemesanan saham (UPDATED)
function openStockOrderModal(ticker) {
    const stock = getStockByTicker(ticker);
    const cur = getCurrent();

    if (!cur) return alert('Silakan Login terlebih dahulu.');
    if (!stock) return toast('Data saham tidak ditemukan.', 3000);

    currentStockOrder = stock;
    const isIDX = stock.currency === 'IDR';
    const lotOrUnit = isIDX ? 'lot' : 'unit';
    const lotSize = isIDX ? STOCK_LOT_SIZE : 1; 
    const priceDecimals = isIDX ? 0 : 2;

    const priceDisplay = isIDX ? fmtRp(stock.price) : fmtUsd(stock.price);
    const changeColor = stock.change >= 0 ? 'pnl-green' : 'pnl-red';
    const changeText = `${stock.change >= 0 ? '+' : ''}${stock.change.toFixed(2)}%`;
    
    const calculateMarginIDR = (price, units, leverage) => {
        let totalValueIDR;
        if (isIDX) {
            totalValueIDR = price * units * lotSize;
        } else {
            totalValueIDR = price * units * FX_IDR_PER_USD;
        }
        
        return Math.round(totalValueIDR / leverage);
    };
    
    const estAmountText = (units, leverage, targetPrice) => {
        const estTotal = calculateMarginIDR(targetPrice, units, leverage);
        const totalNominal = estTotal * leverage;
        const currentData = loadCurrentData();
        const balance = currentData ? currentData.balance : 0;
        
        return `Margin yang dibutuhkan: <span style="color:${estTotal > balance ? '#ff4747' : '#00ff99'};">${fmtRp(estTotal)}</span> (Nilai Nominal: ${fmtRp(totalNominal)})`;
    };

    $('stockOrderLogo').className = `stock-logo ${stock.logo.class}`;
    $('stockOrderLogo').innerHTML = `<span>${stock.ticker}</span>`;
    $('stockOrderTitle').innerText = `${stock.name} (${stock.pair.split(':')[1]})`;
    $('stockOrderPrice').innerHTML = priceDisplay;
    $('stockOrderChange').innerHTML = `<span class="${changeColor}">${changeText}</span>`;
    $('stockTargetPrice').value = stock.price.toFixed(priceDecimals);
    $('stockTargetPrice').placeholder = `Harga Target (${isIDX ? 'Rp' : '$'})`;
    $('stockOrderUnits').placeholder = `Contoh: 1 (${lotOrUnit})`;
    $('stockOrderUnits').value = 1;
    $('stockOrderLeverage').value = 1;

    const updateLeverageMessage = (lev) => {
        $('stockLeverageMessage').innerText = `Leverage yang dipilih: ${lev}x. Total Nilai Nominal: Margin x ${lev}.`;
    };
    
    // Update tampilan awal
    updateLeverageMessage(1);
    $('stockOrderEstAmount').innerHTML = estAmountText(1, 1, stock.price);

    // Update estimasi jumlah/harga/leverage saat input berubah
    const updateEst = () => {
        const units = Number($('stockOrderUnits').value) || 0;
        const targetPrice = Number($('stockTargetPrice').value) || stock.price;
        const leverage = Number($('stockOrderLeverage').value) || 1;
        
        $('stockOrderEstAmount').innerHTML = estAmountText(units, leverage, targetPrice);
        updateLeverageMessage(leverage);
    };

    $('stockOrderUnits').oninput = updateEst;
    $('stockTargetPrice').oninput = updateEst;
    $('stockOrderLeverage').onchange = updateEst;

    // Bind tombol Beli/Jual
    $('btnStockBuy').onclick = () => openStockPosition('Buy', stock.pair, isIDX, lotSize);
    $('btnStockSell').onclick = () => openStockPosition('Sell', stock.pair, isIDX, lotSize);
    
    // Tampilkan modal
    document.getElementById('modalStockOrder').style.display = 'flex';
    
    // Render konten sub-menu default (Orderbook)
    const defaultButton = $('stockSubNav').querySelector('button:first-child');
    renderStockSubContent('Orderbook', defaultButton);
}

// FUNGSI BARU: Membuka posisi Saham
async function openStockPosition(side, pair, isIDX, lotSize) {
    const cur = getCurrent();
    const users = loadUsers();
    const data = users[cur].data;

    const targetPrice = Number($('stockTargetPrice').value);
    const units = Number($('stockOrderUnits').value); // Ini adalah LOT atau UNITS
    
    const leverage = Number($('stockOrderLeverage').value) || 1; 
    
    if (units <= 0) return alert('Masukkan jumlah Unit/Lot yang valid.');
    if (targetPrice <= 0) return alert('Masukkan Harga Beli/Jual yang diinginkan.');
    if (isIDX && units % 1 !== 0) return alert('Saham IDX harus dibeli dalam Lot (angka bulat).');

    // Perhitungan Margin (Amount IDR)
    let totalValue = 0;
    
    if (isIDX) {
        totalValue = targetPrice * units * lotSize;
    } else {
        totalValue = targetPrice * units * FX_IDR_PER_USD;
    }

    // Margin = Total Value / Leverage
    const amountIDR = Math.round(totalValue / leverage);
    
    if (amountIDR > data.balance) {
        return alert(`Saldo tidak cukup. Margin yang dibutuhkan: ${fmtRp(amountIDR)}. Saldo Anda: ${fmtRp(data.balance)}.`);
    }

    // Debit saldo (Margin)
    data.balance -= amountIDR;
    
    // Buat posisi
    const pos = { 
        id:'pos_'+Date.now()+'_'+Math.random().toString(36).slice(2,6), 
        pair, side, 
        entryPrice: targetPrice, 
        units, 
        leverage: leverage,
        amountIDR, // Margin
        pnl:0, pnlPercent:0, 
        time:new Date().toLocaleString() 
    };
    
    data.positions = data.positions || []; data.positions.push(pos);
    data.history = data.history || []; data.history.push({ type: side+' '+pair, amount: -amountIDR, time: pos.time }); 
    users[cur].data = data; saveUsers(users);

    document.getElementById('modalStockOrder').style.display = 'none';
    toast(`Posisi dibuka: ${pair} ${side} @ ${targetPrice.toLocaleString()} dengan Lev ${leverage}x`);

    // Update UI
    renderPositionsUI('tradePositions'); renderPositionsUI('sidePositions'); 
    renderWalletData(); 
    renderMutasiUI('tradeMutasi'); renderMutasiUI('sideMutasi'); renderMutasiUI('walletMutasi');
    if(currentPage === 'stocks') renderStocks();
}


async function openPosition(side){
  const cur = getCurrent();
  if(!cur) return alert('Login dulu');
  const users = loadUsers(); const data = users[cur].data;
  if (data.balance <= 0) {
      alert('Saldo Anda 0. Silakan deposit minimal Rp100.000 untuk memulai perdagangan.');
      return;
  }
  
  const pair = $('pairSelectTrade').value;
  const mode = $('inputModeTrade').value;
  const raw = Number($('openAmountTrade').value || 0);
  const lev = Number($('leverageTrade').value || 1);
  if(raw <= 0) return alert('Masukkan nominal / units');

  // Pengecekan agar saham dibuka lewat menu saham
  if (pair.endsWith(':IDX') || pair.endsWith(':NASDAQ') || pair.endsWith(':INDEX')) {
      return alert('Silakan buka posisi Saham melalui menu "Saham" untuk simulasi Saham, atau pilih pasangan Futures/Crypto di sini.');
  }

  // Price & FX
  const currentPrice = await getPrice(pair);
  // Gunakan harga entry yang disesuaikan sinyal AI (simulasi keberuntungan)
  const entryPrice = getSignalPriceAdjustment(pair, side, currentPrice);

  const fx = pair.includes('USDT')||pair.includes('USD') ? FX_IDR_PER_USD : 1; 
  let units = 0, amountIDR = 0;

  if(mode==='nominal'){ 
    amountIDR = Math.round(raw); 
    units = (amountIDR * lev) / (entryPrice * fx); 
  } else { 
    units = raw; 
    const totalValueIDR = units * entryPrice * fx;
    amountIDR = Math.round(totalValueIDR / lev);
  }
  
  if(amountIDR > data.balance) return alert('Saldo tidak cukup. Margin yang dibutuhkan: '+fmtRp(amountIDR));
  
  // Debit margin
  data.balance -= amountIDR;

  const pos = { id:'pos_'+Date.now()+'_'+Math.random().toString(36).slice(2,6), pair, side, entryPrice: entryPrice, units, leverage: lev, amountIDR, pnl:0, pnlPercent:0, time:new Date().toLocaleString() };
  data.positions = data.positions || []; data.positions.push(pos);
  data.history = data.history || []; data.history.push({ type: side+' '+pair, amount: -amountIDR, time: pos.time }); // debit for open position (margin)
  users[cur].data = data; saveUsers(users);
  toast('Posisi dibuka: ' + pair + ' ' + side);
  renderPositionsUI('tradePositions'); renderWalletData(); renderMutasiUI('tradeMutasi');
}

async function closePositionById(id){
  const cur = getCurrent();
  if(!cur) return alert('Login dulu');
  const users = loadUsers(); const data = users[cur].data;
  const idx = data.positions.findIndex(p=>p.id===id); if(idx===-1) return;
  const p = data.positions[idx];
  const now = await getPrice(p.pair);
  
  const { pnlIDR } = calcPnl(p, now);
  
  // Credit amountIDR (margin) + PnL. 
  const credit = p.amountIDR + pnlIDR;
  data.balance += credit; // Saldo + Margin yang dikembalikan + PnL
  
  data.history.push({ type: 'Close '+p.side+' '+p.pair, amount: credit, time: new Date().toLocaleString() }); // credit for close
  data.positions.splice(idx,1);
  
  users[cur].data = data; saveUsers(users);
  toast('Posisi ditutup. Hasil: Margin kembali + PnL: ' + fmtRp(credit) + ' (PnL: ' + fmtRp(pnlIDR) + ')');
  renderPositionsUI('tradePositions'); renderPositionsUI('sidePositions'); renderWalletData(); renderMutasiUI('tradeMutasi'); renderMutasiUI('sideMutasi'); renderMutasiUI('walletMutasi');
  if(currentPage === 'stocks') renderStocks();
}

/* deposit / withdraw modals (modal flow) */
let pendingDeposit = 0;

function openDepositModal() {
  const nominalInput = document.getElementById('depNominalInput');
  if(nominalInput) nominalInput.value = MIN_DEPOSIT;
  document.getElementById('modalDepNominal').style.display = 'flex';
}

function continueDepositQRIS() {
  const v = Number(document.getElementById('depNominalInput').value);
  if (!v || v < MIN_DEPOSIT) {
      alert('Minimal deposit Rp ' + Number(MIN_DEPOSIT).toLocaleString('id-ID'));
      return;
  }
  pendingDeposit = v;
  document.getElementById('modalDepNominal').style.display = 'none';
  document.getElementById('modalDepQRIS').style.display = 'flex';
  document.getElementById('textPendingDep').innerText = fmtRp(v);
}

function finishDeposit() {
  document.getElementById('modalDepQRIS').style.display = 'none';
  toast('Menunggu verifikasi pembayaran (10 detik)...', 10000); 

  setTimeout(() => {
      const cur = getCurrent();
      if (!cur) return alert('Login dulu');
      
      const users = loadUsers();
      if(!users[cur]) return toast('User tidak ditemukan.', 3000);

      users[cur].data.balance += pendingDeposit;
      users[cur].data.history.push({
          type: 'Deposit',
          amount: pendingDeposit,
          time: new Date().toLocaleString()
      });
      saveUsers(users);
      
      renderWalletData();
      renderMutasiUI('tradeMutasi'); 
      renderMutasiUI('sideMutasi'); 
      renderMutasiUI('walletMutasi');
      
      toast('Deposit sukses: ' + fmtRp(pendingDeposit));
      pendingDeposit = 0; 
  }, 10000);
}

function openWithdrawModal(){ 
  const v = Number(prompt('Withdraw Nominal IDR','100000')); 
  if(!v||v<=0) return; 
  doWithdraw(v);
}
function doWithdraw(v){ 
  const cur=getCurrent(); 
  if(!cur) return alert('Login dulu'); 
  const users=loadUsers(); 
  if(v>users[cur].data.balance) return alert('Saldo tidak cukup'); 
  users[cur].data.balance -= v; 
  users[cur].data.history.push({type:'Withdraw', amount:-v, time:new Date().toLocaleString()}); 
  saveUsers(users); 
  renderWalletData(); 
  renderMutasiUI('tradeMutasi'); renderMutasiUI('sideMutasi'); renderMutasiUI('walletMutasi'); 
  toast('Withdraw -'+fmtRp(v)); 
}
function exportMutasi(){ const cur=getCurrent(); if(!cur) return alert('Login dulu'); const users=loadUsers(); const hist = users[cur].data.history||[]; if(hist.length===0) return alert('Belum ada mutasi'); let csv='timestamp,desc,amount\n'; hist.forEach(h=> csv += `"${h.time}","${h.type.replace(/"/g,'')}",${h.amount}\n`); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='mutasi_'+cur+'.csv'; a.click(); URL.revokeObjectURL(url); }

/* ========== RENDER helpers ========= */
function renderPositionsUI(targetId='tradePositions'){
  const cur = getCurrent(); if(!cur) return;
  const data = loadUsers()[cur].data;
  const box = document.getElementById(targetId);
  if(!box) return;
  if(!data.positions || data.positions.length===0){ box.innerHTML='Belum ada posisi'; return; }
  box.innerHTML = '';
  data.positions.slice().reverse().forEach(p=>{
    const pnlIDR = p.pnl || 0;
    const pnlPercent = p.pnlPercent || 0;
    const pnlColor = getPnlColorClass(pnlIDR);
    
    const isIDX = p.pair.endsWith(':IDX');
    const isUSStock = p.pair.endsWith(':NASDAQ') || p.pair.endsWith(':INDEX');
    const unitLabel = isIDX ? 'Lot' : 'Unit';
    const priceUnit = isIDX ? 'Rp' : (p.pair.includes('USD') || isUSStock ? '$' : '');
    const unitsDisplay = Number(p.units).toFixed(isIDX ? 0 : 6);
    const priceDisplay = Number(p.entryPrice).toFixed(isIDX ? 0 : 6);
    const amountDisplay = fmtRp(Math.round(p.amountIDR));
    
    const el = document.createElement('div');
    el.setAttribute('data-pos-id', p.id); 
    el.style.padding='8px 0'; el.style.borderBottom='1px dashed rgba(255,255,255,0.03)';
    el.innerHTML = `<div style="display:flex;justify-content:space-between">
        <div><b>${p.pair}</b> ‚Ä¢ ${p.side} (${amountDisplay})</div>
        <div class="${pnlColor}" data-pnl-id="${p.id}">
          ${fmtRp(pnlIDR)} <span class="mini">${fmtPnlPercent(pnlPercent)}</span>
        </div>
      </div>
      <div class="small">Entry: ${priceUnit} ${priceDisplay} ‚Ä¢ ${unitLabel}: ${unitsDisplay} ‚Ä¢ Lev: ${p.leverage}x</div>
      <div style="display:flex;gap:8px;margin-top:6px"><button class="btn" onclick="closePositionById('${p.id}')">Tutup Posisi</button></div>`;
    box.appendChild(el);
  });
}

async function updatePositionsPnL(){
  const cur = getCurrent(); if(!cur) return;
  const users = loadUsers(); const data = users[cur].data;
  
  if(!data.positions || data.positions.length===0) return;
  
  const uniquePairs = [...new Set(data.positions.map(p=>p.pair))];
  const prices = {};
  for(const pair of uniquePairs){
    prices[pair] = await getPrice(pair);
  }
  
  data.positions.forEach(p=>{
    const now = prices[p.pair];
    if(!now) return;
    const { pnlIDR, pnlPercent } = calcPnl(p, now);
    p.pnl = pnlIDR; 
    p.pnlPercent = pnlPercent;
    
    ['tradePositions', 'sidePositions'].forEach(targetId => {
      const pnlEl = document.querySelector(`#${targetId} [data-pnl-id="${p.id}"]`);
      if(pnlEl){
        pnlEl.className = getPnlColorClass(pnlIDR);
        pnlEl.innerHTML = `${fmtRp(pnlIDR)} <span class="mini">${fmtPnlPercent(pnlPercent)}</span>`;
      }
    });
  });
  
  users[cur].data = data; saveUsers(users); 
}


function renderPortfolioUI(){
  const cur = getCurrent(); if(!cur) return;
  const data = loadUsers()[cur].data;
  const box = $('tradePortfolio');
  if(!box) return;
  box.innerHTML = '<div class="small">Lihat Portfolio Saham di menu Saham.</div>';
}

function renderMutasiUI(targetId='tradeMutasi'){
  const cur = getCurrent(); if(!cur) return;
  const data = loadUsers()[cur].data;
  const box = document.getElementById(targetId);
  if(!box) return;
  if(!data.history || data.history.length===0) return box.innerHTML = '<div class="small">Belum ada mutasi</div>';
  box.innerHTML = '';
  data.history.slice().reverse().forEach(h=>{
    const el = document.createElement('div'); el.style.padding='8px 0'; el.style.borderBottom='1px dashed rgba(255,255,255,0.03)';
    const amountClass = h.amount > 0 ? 'pnl-green' : (h.amount < 0 ? 'pnl-red' : 'pnl-neutral');
    el.innerHTML = `<div><b>${h.type}</b></div><div class="small">${h.time} ‚Ä¢ <span class="${amountClass}">${fmtRp(h.amount)}</span></div>`;
    box.appendChild(el);
  });
}

/* wallet data */
function renderWalletData(){
  const cur = getCurrent();
  if(!cur) { $('uiNet').textContent = fmtRp(0); return; }
  const data = loadUsers()[cur].data;
  $('uiNet').textContent = fmtRp(data.balance);
  if($('sideBalance')) $('sideBalance').textContent = fmtRp(data.balance);
  if($('walletBalance')) $('walletBalance').textContent = fmtRp(data.balance);
  if($('walletUser')) $('walletUser').textContent = cur;
  if($('walletAddr')) $('walletAddr').textContent = data.addr || '‚Äî';
}

/* market header displays */
async function updateMarketHeaderDisplays(pair){
  const price = await getPrice(pair);
  const priceDecimals = pair.endsWith(':IDX') ? 0 : 6; // Atur desimal untuk IDX/USD
  if($('marketLabelHome')) $('marketLabelHome').textContent = pair;
  if($('priceMainHome')) $('priceMainHome').textContent = Number(price).toFixed(priceDecimals);
  if($('modeLabelHome')) $('modeLabelHome').textContent = window.priceMode === 'realtime' ? 'Realtime' : 'Simulasi';
  if($('hlInfoHome')) { 
    const last = simSeries[pair][simSeries[pair].length-1]; 
    const hlDecimals = pair.endsWith(':IDX') ? 0 : 2;
    $('hlInfoHome').textContent = `H: ${last.h.toFixed(hlDecimals)} ‚Ä¢ L: ${last.l.toFixed(hlDecimals)}`; 
  }
}

/* trade price info and example pnl */
async function updateTradePriceInfo(){
  const pair = $('pairSelectTrade') ? $('pairSelectTrade').value : 'BTC/USDT';
  const price = await getPrice(pair);
  const priceDecimals = pair.endsWith(':IDX') ? 0 : 6;
  if($('tradePriceInfo')) $('tradePriceInfo').textContent = Number(price).toFixed(priceDecimals);
  
  const exampleUnits = 0.01;
  const lev = Number($('leverageTrade') ? $('leverageTrade').value : 1);
  const fx = pair.includes('USDT')||pair.includes('USD') ? FX_IDR_PER_USD : 1; 

  let estPnlIDR = 0;
  let pnlText = '';
  if (pair.endsWith(':IDX') || pair.endsWith(':NASDAQ') || pair.endsWith(':INDEX')) {
      const isIDX = pair.endsWith(':IDX');
      const lotSize = isIDX ? 100 : 1; 
      const fxRate = isIDX ? 1 : FX_IDR_PER_USD;
      estPnlIDR = exampleUnits * 1 * lotSize * fxRate * lev;
      const unitLabel = isIDX ? 'IDR' : 'USD';
      pnlText = `Per 1 ${unitLabel} move ‚Üí ${exampleUnits}√ó1√ó${lotSize}√ó${fxRate}√ó${lev} = ${fmtRp(estPnlIDR)}`;
  } else if (pair.includes('USD')) {
      estPnlIDR = exampleUnits * 1 * FX_IDR_PER_USD * lev;
      pnlText = `Per 1 USD move ‚Üí ${exampleUnits}√ó1√ó${FX_IDR_PER_USD}√ó${lev} = ${fmtRp(estPnlIDR)}`;
  } else {
      estPnlIDR = exampleUnits * 1 * fx * lev;
      pnlText = `Per 1 unit move ‚Üí ${exampleUnits}√ó1√ó${fx}√ó${lev} = ${fmtRp(estPnlIDR)}`;
  }
  
  if($('estPnl')) $('estPnl').textContent = pnlText;
}

/* bind side buttons */
function bindSideButtons(){
  const depBtn = $('openDepBtnSide');
  if(depBtn) depBtn.onclick = ()=> openDepositModal();
}

/* ========== LOGOUT Function ========== */
function doLogout(){
  const users = loadUsers();
  const cur = getCurrent();
  if(cur){
    users[cur].data = loadCurrentData(); 
    saveUsers(users);
  }
  
  setCurrent(''); 
  $('loginModal').style.display='flex'; 
  $('bottomNav').style.display = 'none'; 
  $('loginBtnTop').textContent = 'Login ‚ñæ'; 
  $('loginBtnTop').onclick = ()=> $('loginModal').style.display='flex'; 
  $('uiNet').textContent = fmtRp(0); 
  $('loginUser').value=''; $('loginPass').value=''; 
  navTo('home'); 
  toast('Logout berhasil');
}

/* ========== LOGIN / REGISTER ========== */
$('loginBtnTop').onclick = ()=> {
  if(!getCurrent()){
    $('loginModal').style.display='flex';
  } else {
    doLogout();
  }
};
$('closeLogin').onclick = ()=> $('loginModal').style.display='none';

$('doRegister').onclick = ()=>{
  const u = $('loginUser').value.trim(); const p = $('loginPass').value;
  if(!u||!p) return alert('Isi username & password');
  const users = loadUsers();
  if(users[u]) return alert('Username sudah ada');
  users[u] = { pass:p, data:{ balance:DEFAULT_BAL, history:[], positions:[], portfolio:[], addr:'ADDR_'+Math.random().toString(36).slice(2,8) } };
  saveUsers(users); setCurrent(u); $('loginModal').style.display='none'; toast('Register & login: '+u); postLogin();
};
$('doLogin').onclick = ()=>{
  const u = $('loginUser').value.trim(); const p = $('loginPass').value;
  if(!u||!p) return alert('Isi username & password');
  const users = loadUsers();
  if(!users[u] || users[u].pass !== p) return alert('Username/password salah');
  
  if(!users[u].data.history) users[u].data.history = [];
  if(!users[u].data.positions) users[u].data.positions = [];
  if(!users[u].data.portfolio) users[u].data.portfolio = [];
  if(users[u].data.balance === undefined) users[u].data.balance = DEFAULT_BAL;


  setCurrent(u); $('loginModal').style.display='none'; toast('Login berhasil: '+u); postLogin();
};
$('quickGuest').onclick = ()=>{
  const u = 'guest_'+Math.random().toString(36).slice(2,6);
  ensureUserExists(u); 
  setCurrent(u); $('loginModal').style.display='none'; toast('Masuk sebagai '+u); postLogin();
};

function postLogin(){
  const cur = getCurrent();
  $('loginUser').value=''; $('loginPass').value='';
  renderWalletData();
  renderMutasiUI('tradeMutasi'); renderMutasiUI('sideMutasi'); renderMutasiUI('walletMutasi');
  renderPositionsUI('tradePositions'); renderPositionsUI('sidePositions');
  renderPortfolioUI();
  $('bottomNav').style.display = 'flex';
  $('loginBtnTop').textContent = cur; 
  $('loginBtnTop').onclick = doLogout; 
  navTo('home'); 
}

/* ========== INIT app ======= */
async function startApp(){
  const cur = getCurrent();
  if(!cur){
    $('app').style.display='block'; 
    $('bottomNav').style.display='none'; 
    $('loginBtnTop').textContent = 'Login ‚ñæ'; 
    $('loginBtnTop').onclick = ()=> $('loginModal').style.display='flex'; 
  } else {
    $('app').style.display='block';
    postLogin();
    $('loginModal').style.display='none';
  }

  // Transisi Splash -> Login
  setTimeout(()=>{ 
    $('intro').style.opacity='0'; 
    setTimeout(()=>{
        $('intro').style.display='none';
        if(!cur) $('loginModal').style.display='flex';
    }, 700); // Tunggu hingga fade out selesai (0.7s)
  }, 3000); 
  
  // init default view
  renderPage('home');
  renderWalletData();
  marketLoop();
  setInterval(()=>{ 
    if(currentPage==='trade') updateTradePriceInfo();
  }, 3000);
}
let marketTimer = null;
async function marketLoop(){
  // tick sim series
  PAIRS.forEach(p=>{
    if(Math.random()<0.6){
      const arr = simSeries[p];
      const last = arr[arr.length-1];
      const o = last.c;
      const ch = (Math.random()-0.5)*(volMap[p]||1);
      const isIDX = p.endsWith(':IDX');
      const c = Math.max((o+ch), isIDX ? 1 : 0.0001); 
      const h = Math.max(o,c) + Math.abs(Math.random() * (volMap[p]||1));
      const l = Math.min(o,c) - Math.abs(Math.random() * (volMap[p]||1));
      arr.push({o,c,h,l});
      if(arr.length>900) arr.shift();
    }
  });
  // Update data saham global/IDX dari simSeries
  updateAllStocksData();
  // Update AI Signals
  updateAISignals();

  // update small headers if on home or market
  if(currentPage === 'home') updateMarketHeaderDisplays('BTC/USDT');
  
  // update open positions PnL
  const cur = getCurrent();
  if(cur) updatePositionsPnL();

  // Perbarui tampilan saham jika sedang di halaman stocks
  if(currentPage === 'stocks') renderStocks();
  // Perbarui harga di modal jika sedang dibuka (meski ini tidak optimal, tapi untuk simulasi)
  if(document.getElementById('modalStockOrder').style.display === 'flex' && currentStockOrder) {
      const updatedStock = getStockByTicker(currentStockOrder.ticker);
      if(updatedStock) {
        currentStockOrder = updatedStock; // update current data
        const isIDX = updatedStock.currency === 'IDR';
        const priceDisplay = isIDX ? fmtRp(updatedStock.price) : fmtUsd(updatedStock.price);
        const changeColor = updatedStock.change >= 0 ? 'pnl-green' : 'pnl-red';
        const changeText = `${updatedStock.change >= 0 ? '+' : ''}${updatedStock.change.toFixed(2)}%`;
        
        $('stockOrderPrice').innerHTML = priceDisplay;
        $('stockOrderChange').innerHTML = `<span class="${changeColor}">${changeText}</span>`;
        
        // Update harga target ke harga saat ini hanya jika pengguna belum mengubahnya
        const priceDecimals = isIDX ? 0 : 2;
        if(Number($('stockTargetPrice').value) === Number(currentStockOrder.price.toFixed(priceDecimals))) {
            $('stockTargetPrice').value = currentStockOrder.price.toFixed(priceDecimals);
        }
      }
  }
  
  marketTimer = setTimeout(marketLoop, 1000 + Math.random()*800);
}

/* finally start */
window.onload = startApp;
</script>
<script>
// --- START ADDED TOP MOVERS SCRIPT (TUGAS 2) ---
// UPDATED: Tambah movers baru
const moversData = [
    { pair: "BTC/USDT", base: 0.3 },
    { pair: "ETH/USDT", base: -0.2 },
    { pair: "SOL/USDT", base: 0.8 },
    { pair: "BNB/USDT", base: -0.4 },
    { pair: "AAPL:NASDAQ", base: 0.15 },
    { pair: "BBCA:IDX", base: 0.05 }
];

function renderTopMovers() {
    const box = document.getElementById("topMoversList");
    if(!box) return;
    box.innerHTML = "";

    moversData.forEach(m => {
        let randomMove = (Math.random() * 2 - 1) * 0.4;
        let percent = m.base + randomMove;
        let colorClass = percent >= 0 ? "mover-green" : "mover-red";
        let width = Math.min(Math.abs(percent) * 25, 100); 
        width = Math.max(width, 1); 

        box.innerHTML += `
            <div class="mover-item">
                <div class="mover-header">
                    <span>${m.pair}</span>
                    <span>${percent.toFixed(2)}%</span>
                </div>
                <div class="mover-bar ${colorClass}" style="width:${width}%"></div>
            </div>
        `;
    });
}

// Hanya panggil setInterval sekali (atau biarkan di dalam renderMarket jika Anda ingin ini hanya di Market page)
// Panggil renderTopMovers saat dibutuhkan saja
document.addEventListener("DOMContentLoaded", renderTopMovers);

// --- END ADDED TOP MOVERS SCRIPT (TUGAS 2) ---
</script>
<script>
/* === RELIABLE AUTO-UPDATE ORDERBOOK (SAFE PATCH) === */

(function(){
  let obInterval = null;

  function safeRenderOrderbookIfNeeded(){
    try{
      const modal = document.getElementById('modalStockOrder');
      if(!modal) return;

      // hanya jalan saat modal tampil dan tab aktif Orderbook
      const isOpen = modal.style.display === 'flex' || modal.style.display === 'block';
      const nav = document.getElementById('stockSubNav');
      const activeBtn = nav ? nav.querySelector('button.active') : null;
      const isOrderbook = activeBtn && /orderbook/i.test(activeBtn.innerText);

      if(isOpen && isOrderbook && typeof renderStockSubContent === 'function' && activeBtn){
        // panggil renderStockSubContent untuk refresh orderbook
        try {
          renderStockSubContent('Orderbook', activeBtn);
        } catch(e) {
          console.warn('renderStockSubContent() gagal:', e);
        }
      }
    }catch(e){
      console.error('safeRenderOrderbookIfNeeded error', e);
    }
  }

  function startAuto(){
    stopAuto();
    obInterval = setInterval(safeRenderOrderbookIfNeeded, 1000); // 1 detik
  }
  function stopAuto(){
    if(obInterval){ clearInterval(obInterval); obInterval = null; }
  }

  // Observer: deteksi perubahan display modal
  const modalEl = document.getElementById('modalStockOrder');
  if(modalEl){
    const mo = new MutationObserver(() => {
      const isOpen = modalEl.style.display === 'flex' || modalEl.style.display === 'block';
      if(isOpen) startAuto(); else stopAuto();
    });
    mo.observe(modalEl, { attributes: true, attributeFilter: ['style'] });
  }

  // Jika user klik tombol tab, langsung refresh & pastikan interval jalan saat modal terbuka
  document.addEventListener('click', function(ev){
    try{
      const t = ev.target;
      if(!t) return;
      const modalOpen = modalEl && (modalEl.style.display === 'flex' || modalEl.style.display === 'block');
      if(!modalOpen) return;
      // bila klik tombol di stockSubNav
      if(t.closest && t.closest('#stockSubNav')){
        // beri sedikit delay agar class active sudah berubah
        setTimeout(() => {
          safeRenderOrderbookIfNeeded();
          startAuto();
        }, 100);
      }
    }catch(e){
      // silent
    }
  }, true);

  // Safety: start interval short time saat halaman load jika modal sudah terbuka
  window.addEventListener('load', () => {
    setTimeout(() => {
      if(modalEl && (modalEl.style.display === 'flex' || modalEl.style.display === 'block')) startAuto();
    }, 500);
  });

  // Expose stop/start untuk debugging di console (opsional)
  window.__D4_orderbook = { start: startAuto, stop: stopAuto };

})();
</script>

</body>
</html>
